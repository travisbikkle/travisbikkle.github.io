<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>NetWork on 奇风岁月</title><link>https://travisbikkle.github.io/zh-hant/network/</link><description>Recent content in NetWork on 奇风岁月</description><generator>Hugo -- gohugo.io</generator><language>zh-hant</language><lastBuildDate>Wed, 01 Feb 2023 11:24:24 +0800</lastBuildDate><atom:link href="https://travisbikkle.github.io/zh-hant/network/index.xml" rel="self" type="application/rss+xml"/><item><title>端口轉發的一些方法</title><link>https://travisbikkle.github.io/zh-hant/2023/02/port-forward/</link><pubDate>Wed, 01 Feb 2023 11:24:24 +0800</pubDate><guid>https://travisbikkle.github.io/zh-hant/2023/02/port-forward/</guid><description>在《如何抓包分析 vrrp 報文是否中斷》中我們使用了 iptables 進行指定協議的報文日誌記錄功能，此處新增一個好用的命令。
我們在開發過程中，可能經常需要經過堡壘機、跳板機等中轉一次，才能訪問到處於小網中的服務，如數據庫。使用以下命令，可以在不借助第三方軟件的情況下，完成端口轉發，實現直連小網服務。
iptables 假設 192.168.1.3 是你的小網機器，端口是 15432
1iptables -t nat -A PREROUTING -p tcp --dport 15432 -j DNAT --to-destination 192.168.1.3:15432 2iptables -t nat -A POSTROUTING -p tcp -m tcp --dport 15432 -j MASQUERADE nginx upstream 192.168.1.3 { server 192.168.1.3:15432; } server { listen 15432; proxy_pass 192.168.1.3; proxy_connect_timeout 1h; proxy_timeout 1h; } 或者用 go 自己寫了一些小工具來轉發，我自己還寫了一個自動生成 xshell 配置的工具，因爲在公司內網，不便共享。</description></item><item><title>vrrp 報文抓包的方法</title><link>https://travisbikkle.github.io/zh-hant/2022/02/vrrp-cap/</link><pubDate>Tue, 01 Feb 2022 11:24:24 +0800</pubDate><guid>https://travisbikkle.github.io/zh-hant/2022/02/vrrp-cap/</guid><description>keepalived 的主機和備機，會每隔3s通過單播，向對方發送 vrrp 報文，當備機在 3次*每次心跳間隔（keepalived.conf中的adver_int參數） 都收不到主機的廣播，自己將會升主。
以下兩種可能都會存在：
主機沒有發送廣播 主機發送了廣播，備機沒有收到 因此，在主備都需要監控vrrp的發送（out）或接收（in）記錄。 使用以下兩種方式，都可以監控每次 vrrp 報文的內容，以便定位問題。
iptables 在主機和備機都添加監控vrrp發送和接收的iptables日誌（該規則僅抓取vrrp行爲，沒有其它副作用） 1iptables -t raw -A PREROUTING -p vrrp -j LOG --log-level 6 --log-prefix &amp;#34;VRRP: &amp;#34; 2iptables -t raw -A OUTPUT -p vrrp -j LOG --log-level 6 --log-prefix &amp;#34;VRRP: &amp;#34; 使用以下命令檢測是否添加成功： 1iptables -L -t raw -n 在/var/log/messages可以查看vrrp的記錄。如果是suse或其它操作系統，該日誌中沒有vrrp記錄的話，可以在dmesg或者/var/log/的目錄中grep VRRP查看。 定位完問題後，執行以下命令刪除添加的iptables規則 1iptables -t raw -D PREROUTING -p vrrp -j LOG --log-level 6 --log-prefix &amp;#34;VRRP: &amp;#34; 2iptables -t raw -D OUTPUT -p vrrp -j LOG --log-level 6 --log-prefix &amp;#34;VRRP: &amp;#34; tcpdump wireshark tcpdump 命令需要自行獲取，wireshark 需要自行下載，這部分僅記錄常用命令和注意點，由於在公司內網，圖片無法放上來。</description></item></channel></rss>