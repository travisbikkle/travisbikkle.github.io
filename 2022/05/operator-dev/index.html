<!doctype html><html data-bs-theme="light light" itemscope itemtype=http://schema.org/WebPage lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?display=swap&amp;family=Poppins&amp;family=Agbalumo" rel=stylesheet><link rel=manifest href=https://travisbikkle.github.io/manifest.webmanifest><meta name=description content="如何写一个 K8s Operator"><link rel=icon href=/images/logo.svg type=image/svg+xml><link rel=apple-touch-icon href=/images/logo_hub7ff5b15a111a79c0ee3a783e6fa4fdd_94335_192x192_resize_box_3.png sizes=192x192 type=image/png><link rel=mask-icon href=/images/logo.svg color=#7952b3><meta property="og:title" content="如何写一个 K8s Operator"><meta property="og:description" content="如何写一个 K8s Operator"><meta property="og:type" content="article"><meta property="og:url" content="https://travisbikkle.github.io/2022/05/operator-dev/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-26T11:24:26+08:00"><meta property="article:modified_time" content="2024-07-29T10:11:29+08:00"><meta itemprop=name content="如何写一个 K8s Operator"><meta itemprop=description content="如何写一个 K8s Operator"><meta itemprop=datePublished content="2022-05-26T11:24:26+08:00"><meta itemprop=dateModified content="2024-07-29T10:11:29+08:00"><meta itemprop=wordCount content="1413"><meta itemprop=keywords content="k8s,operator pattern,"><link rel=alternate hreflang=zh-hant href=https://travisbikkle.github.io/zh-hant/2022/05/operator-dev/><meta name=twitter:card content="summary"><meta name=twitter:title content="如何写一个 K8s Operator"><meta name=twitter:description content="如何写一个 K8s Operator"><title>如何写一个 K8s Operator - 文章 - 奇风岁月</title><link rel=stylesheet href=/css/aos.min.css>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8463165538265825" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-0RP57KXQV8"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-0RP57KXQV8",{anonymize_ip:!1})}</script><link href="/css/hb.fafd8108d3c76a93bca4e999f7097f9d61fd930497546b8eb38f77fca256220f.css" rel=stylesheet><script src=/js/init.577d4e90bff5601d5756fcf799b0e53568bf56cea3b80fe43f66c9d365e8100c.js integrity="sha256-V31OkL/1YB1XVvz3mbDlNWi/Vs6juA/kP2bJ02XoEAw="></script><link rel=stylesheet href=/css/search.ee67fb063f2e4be8eff1be9d9806279c3c3d43570b6266c759281faac3804b11.css><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","kpbh8gdtr6")</script></head><body><noscript><div class="alert alert-danger text-center rounded-0" role=alert><svg aria-hidden="true" class="bi bi-exclamation-square-fillbi bi-exclamation-square-fill hi-svg-inline me-2" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2 0A2 2 0 000 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2zm6 4c.535.0.954.462.9.995l-.35 3.507a.552.552.0 01-1.1.0L7.1 4.995A.905.905.0 018 4m.002 6a1 1 0 110 2 1 1 0 010-2"/></svg>你的浏览器不支持 JavaScript。</div></noscript><header class=hb-header><nav class="hb-header-nav navbar navbar-expand-lg"><div class=container-fluid><a class="navbar-brand d-flex align-items-center" href=/><img src=https://travisbikkle.github.io/images/logo_hub7ff5b15a111a79c0ee3a783e6fa4fdd_94335_0x64_resize_box_3.png alt=Logo width=64 height=64 class="hb-header-logo d-inline-block align-text-top me-2">奇风岁月</a><div class="d-flex order-5"><div class="search-modal-toggle hb-header-search-form d-flex align-items-center ms-lg-1"><div class="hb-header-search-input-container position-relative"><button type=button class="hb-header-search-icon border-0 bg-transparent px-2 d-flex d-lg-block" aria-label="Toggle search">
<svg aria-hidden="true" class="bi bi-searchbi bi-search hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M11.742 10.344a6.5 6.5.0 10-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 001.415-1.414l-3.85-3.85a1 1 0 00-.115-.1zM12 6.5a5.5 5.5.0 11-11 0 5.5 5.5.0 0111 0"/></svg></button>
<input class="form-control rounded-5 d-none d-lg-block ms-lg-1" id=hb-header-search-input placeholder=搜索>
<span class="hb-header-search-keys position-absolute d-none d-lg-block"><kbd>CTRL</kbd>
<kbd>K</kbd></span></div></div><button class="navbar-toggler border-0 shadow-none px-2" type=button data-bs-toggle=offcanvas data-bs-target=#hb-header-content aria-controls=hb-header-content aria-label="Toggle navigation"><svg aria-hidden="true" class="bi bi-three-dotsbi bi-three-dots hi-svg-inline" fill="currentcolor" height="1.25em" viewBox="0 0 16 16" width="1.25em" xmlns="http://www.w3.org/2000/svg"><path d="M3 9.5a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3m5 0a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg></button></div><div class="offcanvas offcanvas-lg offcanvas-end" tabindex=-1 id=hb-header-content aria-labelledby=hb-header-content-label><div class=offcanvas-header><h5 class=offcanvas-title id=hb-header-content-label>奇风岁月</h5><button type=button class=btn-close data-bs-dismiss=offcanvas aria-label=Close></button></div><div class=offcanvas-body><ul class="hb-header-menus navbar-nav flex-row flex-wrap"><li class="hb-header-menu nav-item col-6 col-lg-auto"><a class=nav-link href=https://travisbikkle.github.io/><svg aria-hidden="true" class="bi bi-bookbi bi-book hi-svg-inline hb-header-menu-icon me-1" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5.0 000 2.5v11a.5.5.0 00.707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5.0 00.78.0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5.0 0016 13.5v-11a.5.5.0 00-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783"/></svg>文档</a></li><li class="hb-header-menu dropdown nav-item col-12 col-lg-auto active"><a class="nav-link pe-0 d-inline-flex align-items-center active" href=/ aria-current=page><svg aria-hidden="true" class="hi-svg-inline hb-header-menu-icon me-1" fill="currentcolor" height="1em" viewBox="0 0 512 512" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M192 32c0 17.7 14.3 32 32 32 123.7.0 224 100.3 224 224 0 17.7 14.3 32 32 32s32-14.3 32-32C512 128.9 383.1.0 224 0c-17.7.0-32 14.3-32 32zm0 96c0 17.7 14.3 32 32 32 70.7.0 128 57.3 128 128 0 17.7 14.3 32 32 32s32-14.3 32-32c0-106-86-192-192-192-17.7.0-32 14.3-32 32zM96 144c0-26.5-21.5-48-48-48S0 117.5.0 144V368c0 79.5 64.5 144 144 144s144-64.5 144-144-64.5-144-144-144H128v96h16c26.5.0 48 21.5 48 48s-21.5 48-48 48-48-21.5-48-48V144z"/></svg>博客</a>
<a class="nav-link ps-0 d-inline-flex" href=# id=header-menu-blog role=button data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span><svg aria-hidden="true" class="bi bi-chevron-compact-downbi bi-chevron-compact-down hi-svg-inline" fill="currentcolor" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1.553 6.776a.5.5.0 01.67-.223L8 9.44l5.776-2.888a.5.5.0 11.448.894l-6 3a.5.5.0 01-.448.0l-6-3a.5.5.0 01-.223-.67"/></svg></a><ul class="hb-header-submenus dropdown-menu" aria-labelledby=header-menu-blog data-columns=2 data-bs-popper=none><li><a class="hb-header-submenu dropdown-item d-flex align-items-center active" href=https://travisbikkle.github.io/posts/><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-file-richtextbi bi-file-richtext hi-svg-inline text-primary" fill="currentcolor" height="2em" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M7 4.25a.75.75.0 11-1.5.0.75.75.0 011.5.0m-.861 1.542 1.33.886 1.854-1.855a.25.25.0 01.289-.047l1.888.974V7.5A.5.5.0 0111 8H5a.5.5.0 01-.5-.5V7s1.54-1.274 1.639-1.208M5 9a.5.5.0 000 1h6a.5.5.0 000-1zm0 2a.5.5.0 000 1h3a.5.5.0 000-1z"/><path d="M2 2a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H4a2 2 0 01-2-2zm10-1H4A1 1 0 003 2v12a1 1 0 001 1h8a1 1 0 001-1V2a1 1 0 00-1-1"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">文章</div><p class="dropdown-item-desc mb-0 text-wrap">文章列表。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href=https://travisbikkle.github.io/series/><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-columnsbi bi-columns hi-svg-inline" fill="currentcolor" height="2em" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M0 2a1 1 0 011-1h14a1 1 0 011 1v12a1 1 0 01-1 1H1a1 1 0 01-1-1zm8.5.0v8H15V2zm0 9v3H15v-3zm-1-9H1v3h6.5zM1 14h6.5V6H1z"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">专栏</div><p class="dropdown-item-desc mb-0 text-wrap">所有专栏。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href=https://travisbikkle.github.io/authors/><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-pencilbi bi-pencil hi-svg-inline" fill="currentcolor" height="2em" style="color:#0f5e97" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M12.146.146a.5.5.0 01.708.0l3 3a.5.5.0 010 .708l-10 10a.5.5.0 01-.168.11l-5 2a.5.5.0 01-.65-.65l2-5a.5.5.0 01.11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5.0 01.5.5v.5h.5a.5.5.0 01.5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5.0 015 12.5V12h-.5a.5.5.0 01-.5-.5V11h-.5a.5.5.0 01-.468-.325"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">作者</div><p class="dropdown-item-desc mb-0 text-wrap">作者列表。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href=https://travisbikkle.github.io/categories/><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-folderbi bi-folder hi-svg-inline" fill="currentcolor" height="2em" style="color:orange" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M.54 3.87.5 3a2 2 0 012-2h3.672a2 2 0 011.414.586l.828.828A2 2 0 009.828 3h3.982a2 2 0 011.992 2.181l-.637 7A2 2 0 0113.174 14H2.826A2 2 0 01.835 12.181l-.637-7a2 2 0 01.342-1.31zM2.19 4a1 1 0 00-.996 1.09l.637 7a1 1 0 00.995.91h10.348a1 1 0 00.995-.91l.637-7A1 1 0 0013.81 4zm4.69-1.707A1 1 0 006.172 2H2.5a1 1 0 00-1 .981l.006.139q.323-.119.684-.12h5.396z"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">分类</div><p class="dropdown-item-desc mb-0 text-wrap">所有分类。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href=https://travisbikkle.github.io/archives/><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-archivebi bi-archive hi-svg-inline" fill="currentcolor" height="2em" style="color:384955" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M0 2a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1v7.5A2.5 2.5.0 0112.5 15h-9A2.5 2.5.0 011 12.5V5A1 1 0 010 4zm2 3v7.5A1.5 1.5.0 003.5 14h9a1.5 1.5.0 001.5-1.5V5zm13-3H1v2h14zM5 7.5a.5.5.0 01.5-.5h5a.5.5.0 010 1h-5A.5.5.0 015 7.5"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">归档</div><p class="dropdown-item-desc mb-0 text-wrap">文章归档。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href=https://travisbikkle.github.io/news/><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-newspaperbi bi-newspaper hi-svg-inline" fill="currentcolor" height="2em" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M0 2.5A1.5 1.5.0 011.5 1h11A1.5 1.5.0 0114 2.5v10.528c0 .3-.05.654-.238.972h.738a.5.5.0 00.5-.5v-9a.5.5.0 011 0v9A1.5 1.5.0 0114.5 15H1.497A1.497 1.497.0 010 13.5zM12 14c.37.0.654-.211.853-.441.092-.106.147-.279.147-.531V2.5a.5.5.0 00-.5-.5h-11a.5.5.0 00-.5.5v11c0 .278.223.5.497.5z"/><path d="M2 3h10v2H2zm0 3h4v3H2zm0 4h4v1H2zm0 2h4v1H2zm5-6h2v1H7zm3 0h2v1h-2zM7 8h2v1H7zm3 0h2v1h-2zm-3 2h2v1H7zm3 0h2v1h-2zm-3 2h2v1H7zm3 0h2v1h-2z"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">新闻</div><p class="dropdown-item-desc mb-0 text-wrap">关于网站和模块发布的消息。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href=https://travisbikkle.github.io/tags/><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="bi bi-tagsbi bi-tags hi-svg-inline" fill="currentcolor" height="2em" style="color:green" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M3 2v4.586l7 7L14.586 9l-7-7zM2 2a1 1 0 011-1h4.586a1 1 0 01.707.293l7 7a1 1 0 010 1.414l-4.586 4.586a1 1 0 01-1.414.0l-7-7A1 1 0 012 6.586z"/><path d="M5.5 5a.5.5.0 110-1 .5.5.0 010 1m0 1a1.5 1.5.0 100-3 1.5 1.5.0 000 3M1 7.086a1 1 0 00.293.707L8.75 15.25l-.043.043a1 1 0 01-1.414.0l-7-7A1 1 0 010 7.586V3a1 1 0 011-1z"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">标签</div><p class="dropdown-item-desc mb-0 text-wrap">所有标签。</p></div></a></li></ul></li><li class="hb-header-menu dropdown nav-item col-12 col-lg-auto"><a class="nav-link pe-0 d-inline-flex align-items-center" href=https://github.com/travisbikkle/ target=_blank rel=external><svg aria-hidden="true" class="hi-svg-inline hb-header-menu-icon me-1" fill="currentcolor" height="1em" viewBox="0 0 512 512" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M256 48C141.1 48 48 141.1 48 256v40c0 13.3-10.7 24-24 24S0 309.3.0 296V256C0 114.6 114.6.0 256 0S512 114.6 512 256V400.1c0 48.6-39.4 88-88.1 88L313.6 488c-8.3 14.3-23.8 24-41.6 24H240c-26.5.0-48-21.5-48-48s21.5-48 48-48h32c17.8.0 33.3 9.7 41.6 24l110.4.1c22.1.0 40-17.9 40-40V256c0-114.9-93.1-208-208-208zM144 208h16c17.7.0 32 14.3 32 32V352c0 17.7-14.3 32-32 32H144c-35.3.0-64-28.7-64-64V272c0-35.3 28.7-64 64-64zm224 0c35.3.0 64 28.7 64 64v48c0 35.3-28.7 64-64 64H352c-17.7.0-32-14.3-32-32V240c0-17.7 14.3-32 32-32h16z"/></svg>支持</a>
<a class="nav-link ps-0 d-inline-flex" href=# id=header-menu-support role=button data-bs-toggle=dropdown aria-expanded=false><span class=visually-hidden>Toggle Dropdown</span><svg aria-hidden="true" class="bi bi-chevron-compact-downbi bi-chevron-compact-down hi-svg-inline" fill="currentcolor" height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1.553 6.776a.5.5.0 01.67-.223L8 9.44l5.776-2.888a.5.5.0 11.448.894l-6 3a.5.5.0 01-.448.0l-6-3a.5.5.0 01-.223-.67"/></svg></a><ul class="hb-header-submenus dropdown-menu" aria-labelledby=header-menu-support data-bs-popper=none><li class=column-span-all><h6 class=dropdown-header>和我们联系。</h6></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href=https://github.com/travisbikkle/ target=_blank rel=external><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="2em" viewBox="0 0 496 512" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">GitHub</div><p class="dropdown-item-desc mb-0 text-wrap">代码仓库。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href=https://github.com/orgs/org-travis/discussions/ target=_blank rel=external><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="2em" style="color:green" viewBox="0 0 640 512" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M88.2 309.1c9.8-18.3 6.8-40.8-7.5-55.8C59.4 230.9 48 204 48 176c0-63.5 63.8-128 160-128s160 64.5 160 128-63.8 128-160 128c-13.1.0-25.8-1.3-37.8-3.6-10.4-2-21.2-.6-30.7 4.2-4.1 2.1-8.3 4.1-12.6 6-16 7.2-32.9 13.5-49.9 18 2.8-4.6 5.4-9.1 7.9-13.6 1.1-1.9 2.2-3.9 3.2-5.9zM0 176c0 41.8 17.2 80.1 45.9 110.3-.9 1.7-1.9 3.5-2.8 5.1-10.3 18.4-22.3 36.5-36.6 52.1-6.6 7-8.3 17.2-4.6 25.9C5.8 378.3 14.4 384 24 384c43 0 86.5-13.3 122.7-29.7 4.8-2.2 9.6-4.5 14.2-6.8 15.1 3 30.9 4.5 47.1 4.5 114.9.0 208-78.8 208-176S322.9.0 208 0 0 78.8.0 176zM432 480c16.2.0 31.9-1.6 47.1-4.5 4.6 2.3 9.4 4.6 14.2 6.8C529.5 498.7 573 512 616 512c9.6.0 18.2-5.7 22-14.5s2-19-4.6-25.9c-14.2-15.6-26.2-33.7-36.6-52.1-.9-1.7-1.9-3.4-2.8-5.1 28.8-30.3 46-68.6 46-110.4.0-94.4-87.9-171.5-198.2-175.8 4.1 15.2 6.2 31.2 6.2 47.8v.6c87.2 6.7 144 67.5 144 127.4.0 28-11.4 54.9-32.7 77.2-14.3 15-17.3 37.6-7.5 55.8 1.1 2 2.2 4 3.2 5.9 2.5 4.5 5.2 9 7.9 13.6-17-4.5-33.9-10.7-49.9-18-4.3-1.9-8.5-3.9-12.6-6-9.5-4.8-20.3-6.2-30.7-4.2-12.1 2.4-24.7 3.6-37.8 3.6-61.7.0-110-26.5-136.8-62.3-16 5.4-32.8 9.4-50 11.8C279 439.8 350 480 432 480z"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">讨论</div><p class="dropdown-item-desc mb-0 text-wrap">提问题和分享你的想法。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href="https://github.com/orgs/org-travis/discussions/new?category=issues-and-bugs" target=_blank rel=external><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="2em" style="color:red" viewBox="0 0 512 512" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M256 0c53 0 96 43 96 96v3.6c0 15.7-12.7 28.4-28.4 28.4H188.4c-15.7.0-28.4-12.7-28.4-28.4V96c0-53 43-96 96-96zM41.4 105.4c12.5-12.5 32.8-12.5 45.3.0l64 64c.7.7 1.3 1.4 1.9 2.1 14.2-7.3 30.4-11.4 47.5-11.4H312c17.1.0 33.2 4.1 47.5 11.4.6-.7 1.2-1.4 1.9-2.1l64-64c12.5-12.5 32.8-12.5 45.3.0s12.5 32.8.0 45.3l-64 64c-.7.7-1.4 1.3-2.1 1.9 6.2 12 10.1 25.3 11.1 39.5H480c17.7.0 32 14.3 32 32s-14.3 32-32 32H416c0 24.6-5.5 47.8-15.4 68.6 2.2 1.3 4.2 2.9 6 4.8l64 64c12.5 12.5 12.5 32.8.0 45.3s-32.8 12.5-45.3.0l-63.1-63.1c-24.5 21.8-55.8 36.2-90.3 39.6V240c0-8.8-7.2-16-16-16s-16 7.2-16 16V479.2c-34.5-3.4-65.8-17.8-90.3-39.6L86.6 502.6c-12.5 12.5-32.8 12.5-45.3.0s-12.5-32.8.0-45.3l64-64c1.9-1.9 3.9-3.4 6-4.8C101.5 367.8 96 344.6 96 320H32c-17.7.0-32-14.3-32-32s14.3-32 32-32H96.3c1.1-14.1 5-27.5 11.1-39.5-.7-.6-1.4-1.2-2.1-1.9l-64-64c-12.5-12.5-12.5-32.8.0-45.3z"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">Bug 反馈</div><p class="dropdown-item-desc mb-0 text-wrap">向我们反馈一个错误或问题。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href="https://github.com/orgs/org-travis/discussions/new?category=ideas" target=_blank rel=external><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="2em" style="color:orange" viewBox="0 0 384 512" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M297.2 248.9C311.6 228.3 320 203.2 320 176c0-70.7-57.3-128-128-128S64 105.3 64 176c0 27.2 8.4 52.3 22.8 72.9 3.7 5.3 8.1 11.3 12.8 17.7 12.9 17.7 28.3 38.9 39.8 59.8 10.4 19 15.7 38.8 18.3 57.5H109c-2.2-12-5.9-23.7-11.8-34.5-9.9-18-22.2-34.9-34.5-51.8-5.2-7.1-10.4-14.2-15.4-21.4C27.6 247.9 16 213.3 16 176 16 78.8 94.8.0 192 0s176 78.8 176 176c0 37.3-11.6 71.9-31.4 100.3-5 7.2-10.2 14.3-15.4 21.4-12.3 16.8-24.6 33.7-34.5 51.8-5.9 10.8-9.6 22.5-11.8 34.5H226.4c2.6-18.7 7.9-38.6 18.3-57.5 11.5-20.9 26.9-42.1 39.8-59.8 4.7-6.4 9-12.4 12.7-17.7zM192 128c-26.5.0-48 21.5-48 48 0 8.8-7.2 16-16 16s-16-7.2-16-16c0-44.2 35.8-80 80-80 8.8.0 16 7.2 16 16s-7.2 16-16 16zm0 384c-44.2.0-80-35.8-80-80V416H272v16c0 44.2-35.8 80-80 80z"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">功能提议</div><p class="dropdown-item-desc mb-0 text-wrap">建议新的或需要改进的功能。</p></div></a></li><li><a class="hb-header-submenu dropdown-item d-flex align-items-center" href=https://travisbikkle.github.io/contact><div class="dropdown-item-icon d-flex align-items-center bg-body-secondary bg-gradient rounded me-2 p-2"><svg aria-hidden="true" class="hi-svg-inline" fill="currentcolor" height="2em" style="color:#000" viewBox="0 0 512 512" width="2em" xmlns="http://www.w3.org/2000/svg"><path d="M64 112c-8.8.0-16 7.2-16 16v22.1L220.5 291.7c20.7 17 50.4 17 71.1.0L464 150.1V128c0-8.8-7.2-16-16-16H64zM48 212.2V384c0 8.8 7.2 16 16 16H448c8.8.0 16-7.2 16-16V212.2L322 328.8c-38.4 31.5-93.7 31.5-132 0L48 212.2zM0 128C0 92.7 28.7 64 64 64H448c35.3.0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H64c-35.3.0-64-28.7-64-64V128z"/></svg></div><div class=dropdown-item-content><div class="dropdown-item-title mb-1">联系</div><p class="dropdown-item-desc mb-0 text-wrap">联系我们。</p></div></a></li></ul></li></ul><ul class="hb-header-panel navbar-nav flex-row flex-wrap"><li class="nav-item py-2 py-lg-1 col-12 col-lg-auto"><hr class="d-lg-none my-2 text-body-50"></li><li class="nav-item col-6 col-lg-auto d-flex align-items-center"><a class="hb-social btn btn-link nav-link py-2 px-0 px-lg-2 d-flex justify-content-center align-items-center" href=https://github.com/travisbikkle target=_blank rel="nofollow me" title=GitHub><svg aria-hidden="true" class="hi-svg-inline hb-social-icon" fill="currentcolor" height="1em" role="img" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg><span class="hb-social-text d-lg-none ms-1">GitHub</span></a></li><li class="nav-item col-6 col-lg-auto d-flex align-items-center"><a class="hb-social btn btn-link nav-link py-2 px-0 px-lg-2 d-flex justify-content-center align-items-center" href=https://github.com/sponsors/travisbikkle target=_blank rel="nofollow me" title=Githubsponsors><svg aria-hidden="true" class="hi-svg-inline hb-social-icon" fill="currentcolor" height="1em" role="img" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><title>GitHub Sponsors</title><path d="M17.625 1.499c-2.32.0-4.354 1.203-5.625 3.03-1.271-1.827-3.305-3.03-5.625-3.03C3.129 1.499.0 4.253.0 8.249c0 4.275 3.068 7.847 5.828 10.227a33.14 33.14.0 005.616 3.876l.028.017.008.003-.001.003c.163.085.342.126.521.125.179.001.358-.041.521-.125l-.001-.003.008-.003.028-.017a33.14 33.14.0 005.616-3.876C20.932 16.096 24 12.524 24 8.249c0-3.996-3.129-6.75-6.375-6.75zm-.919 15.275a30.766 30.766.0 01-4.703 3.316l-.004-.002-.004.002a30.955 30.955.0 01-4.703-3.316c-2.677-2.307-5.047-5.298-5.047-8.523.0-2.754 2.121-4.5 4.125-4.5 2.06.0 3.914 1.479 4.544 3.684.143.495.596.797 1.086.796.49.001.943-.302 1.085-.796.63-2.205 2.484-3.684 4.544-3.684 2.004.0 4.125 1.746 4.125 4.5.0 3.225-2.37 6.216-5.048 8.523z"/></svg><span class="hb-social-text d-lg-none ms-1">Githubsponsors</span></a></li><li class="nav-item col-6 col-lg-auto d-flex align-items-center"><a class="hb-social btn btn-link nav-link py-2 px-0 px-lg-2 d-flex justify-content-center align-items-center" href=/index.xml target=_blank rel="nofollow me" title=RSS><svg aria-hidden="true" class="bi bi-rss-fillbi bi-rss-fill hi-svg-inline hb-social-icon" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2 0A2 2 0 000 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2zm1.5 2.5c5.523.0 10 4.477 10 10a1 1 0 11-2 0 8 8 0 00-8-8 1 1 0 010-2m0 4a6 6 0 016 6 1 1 0 11-2 0 4 4 0 00-4-4 1 1 0 010-2m.5 7a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg><span class="hb-social-text d-lg-none ms-1">RSS</span></a></li><li class="nav-item py-2 py-lg-1 col-12 col-lg-auto"><div class="vr d-none d-lg-flex h-100 mx-lg-2 text-body"></div><hr class="d-lg-none my-2 text-body-50"></li><li class="language-picker nav-item dropdown col-6 col-lg-auto d-flex flex-column justify-content-start justify-content-lg-center"><a class="btn btn-link nav-link py-2 px-0 px-lg-2 d-flex justify-content-start justify-content-lg-center align-items-center" href=# role=button data-bs-toggle=dropdown aria-expanded=false title="Language picker"><svg aria-hidden="true" class="bi bi-globebi bi-globe hi-svg-inline my-1 language-picker-icon" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8m7.5-6.923c-.67.204-1.335.82-1.887 1.855A8 8 0 005.145 4H7.5zM4.09 4a9.3 9.3.0 01.64-1.539 7 7 0 01.597-.933A7.03 7.03.0 002.255 4zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a7 7 0 00-.656 2.5zM4.847 5a12.5 12.5.0 00-.338 2.5H7.5V5zM8.5 5v2.5h2.99A12.5 12.5.0 0011.153 5zM4.51 8.5a12.5 12.5.0 00.337 2.5H7.5V8.5zm3.99.0V11h2.653c.187-.765.306-1.608.338-2.5zM5.145 12q.208.58.468 1.068c.552 1.035 1.218 1.65 1.887 1.855V12zm.182 2.472a7 7 0 01-.597-.933A9.3 9.3.0 014.09 12H2.255a7 7 0 003.072 2.472M3.82 11a13.7 13.7.0 01-.312-2.5h-2.49c.062.89.291 1.733.656 2.5zm6.853 3.472A7 7 0 0013.745 12H11.91a9.3 9.3.0 01-.64 1.539 7 7 0 01-.597.933M8.5 12v2.923c.67-.204 1.335-.82 1.887-1.855q.26-.487.468-1.068zm3.68-1h2.146c.365-.767.594-1.61.656-2.5h-2.49A13.7 13.7.0 0112.18 11m2.802-3.5A7 7 0 0014.326 5H12.18c.174.782.282 1.623.312 2.5zM11.27 2.461c.247.464.462.98.64 1.539h1.835a7 7 0 00-3.072-2.472c.218.284.418.598.597.933M10.855 4a8 8 0 00-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4z"/></svg><span class="d-lg-none ms-1">简体中文</span></a><ul class="language-picker-menu dropdown-menu dropdown-menu-end"><li><a class="language-picker-item dropdown-item" href=https://travisbikkle.github.io/en/>English</a></li><li><a class="language-picker-item dropdown-item active" href=https://travisbikkle.github.io/>简体中文</a></li><li><a class="language-picker-item dropdown-item" href=https://travisbikkle.github.io/zh-hant/>繁體中文</a></li></ul></li><li class="theme-toggle nav-item dropdown col-6 col-lg-auto d-flex flex-column justify-content-start justify-content-lg-center"><button class="btn btn-link btn-theme-toggle nav-link py-2 px-0 px-lg-2 d-flex justify-content-start justify-content-lg-center align-items-center" data-style=switch aria-expanded=false title=主题>
<svg aria-hidden="true" class="bi bi-circle-halfbi bi-circle-half hi-svg-inline my-1 theme-toggle-icon" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 15A7 7 0 108 1zm0 1A8 8 0 118 0a8 8 0 010 16"/></svg><span class="d-lg-none ms-1 theme-name">主题</span></button><ul class="theme-toggle-menu dropdown-menu dropdown-menu-end"><li><button class="theme-toggle-item dropdown-item d-flex align-items-center justify-content-center" data-bs-theme-name=自动 data-bs-theme-value=auto>
<span class="theme-toggle-item-icon me-1 d-flex align-items-center"><svg aria-hidden="true" class="bi bi-circle-halfbi bi-circle-half hi-svg-inline my-1" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 15A7 7 0 108 1zm0 1A8 8 0 118 0a8 8 0 010 16"/></svg></span>自动</button></li><li><button class="theme-toggle-item dropdown-item d-flex align-items-center justify-content-center" data-bs-theme-name=暗色 data-bs-theme-value=dark>
<span class="theme-toggle-item-icon me-1 d-flex align-items-center"><svg aria-hidden="true" class="bi bi-moon-starsbi bi-moon-stars hi-svg-inline my-1" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 .278a.77.77.0 01.08.858 7.2 7.2.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79.0 01.81.316.73.73.0 01-.031.893A8.35 8.35.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.75.75.0 016 .278M4.858 1.311A7.27 7.27.0 001.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.32 7.32.0 005.205-2.162q-.506.063-1.029.063c-4.61.0-8.343-3.714-8.343-8.29.0-1.167.242-2.278.681-3.286"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.73 1.73.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.73 1.73.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.73 1.73.0 001.097-1.097zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.16 1.16.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.16 1.16.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732z"/></svg></span>暗色</button></li><li><button class="theme-toggle-item dropdown-item d-flex align-items-center justify-content-center" data-bs-theme-name=亮色 data-bs-theme-value=light>
<span class="theme-toggle-item-icon me-1 d-flex align-items-center"><svg aria-hidden="true" class="bi bi-brightness-highbi bi-brightness-high hi-svg-inline my-1" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 11a3 3 0 110-6 3 3 0 010 6m0 1a4 4 0 100-8 4 4 0 000 8M8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0m0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13m8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5M3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8m10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0m-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0m9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707M4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708"/></svg></span>亮色</button></li></ul></li></ul></div></div></div></nav></header><div class="hb-main container"><div class=hb-blog-main-container><div class=hb-blog-main><div class="container-fluid px-0 mb-4"><nav aria-label=breadcrumb><ol class="hb-breadcrumb breadcrumb"><li class=breadcrumb-item><a href=/ title=博客>主页</a></li><li class=breadcrumb-item><a href=/posts/ title=文章>文章</a></li><li class="breadcrumb-item active" aria-current=page><a href=/2022/05/operator-dev/ title="如何写一个 K8s Operator">如何写一个 K8s Operator</a></li></ol></nav></div><div class="hb-blog-post position-relative"><div class="hb-blog-post-intro hb-module mb-2"><h1 class="hb-blog-post-title text-break">如何写一个 K8s Operator</h1><div class=hb-blog-post-meta><span class=hb-blog-post-date>2022年5月26日</span>
<span class=hb-blog-post-reading-time>7 分钟阅读</span>
<span class=hb-blog-post-taxonomy-meta><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-category badge bg-secondary text-decoration-none fw-normal me-1" href=/categories/tips/>Tips</a>
</span><span class=hb-blog-post-taxonomy-meta><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-tag badge bg-secondary text-decoration-none fw-normal me-1" href=/k8s/>k8s</a>
</span><span class=hb-blog-post-taxonomy-meta><a class="hb-blog-post-taxonomy hb-blog-post-taxonomy-tag badge bg-secondary text-decoration-none fw-normal me-1" href=/operator-pattern/>operator pattern</a></span></div><div class="hb-blog-post-desc lead mt-1">如何写一个 K8s Operator</div></div><div class="hb-blog-post-toc text-body-secondary position-sticky overflow-y-auto"><div class="hb-module pb-1"><div class="h6 d-none d-md-block">本页内容</div><hr class="d-none d-md-block"><div class="d-grid d-block d-md-none mb-2"><button class="btn btn-light d-flex align-items-center justify-content-between collapsed" type=button data-bs-toggle=collapse data-bs-target=.hb-blog-post-toc-collapse aria-expanded=false aria-controls=collapse-toc>
<span>本页内容</span><svg aria-hidden="true" class="bi bi-chevron-expandbi bi-chevron-expand hi-svg-inline ms-2" fill="currentcolor" height="1.25rem" viewBox="0 0 16 16" width="1.25rem" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3.646 9.146a.5.5.0 01.708.0L8 12.793l3.646-3.647a.5.5.0 01.708.708l-4 4a.5.5.0 01-.708.0l-4-4a.5.5.0 010-.708m0-2.292a.5.5.0 00.708.0L8 3.207l3.646 3.647a.5.5.0 00.708-.708l-4-4a.5.5.0 00-.708.0l-4 4a.5.5.0 000 .708"/></svg></button></div><div class="px-2 px-md-0"><div id=collapse-toc class="collapse hb-blog-post-toc-collapse"><nav id=TableOfContents><ul><li><a href=#operator-是什么>Operator 是什么</a></li><li><a href=#看看一个案例>看看一个案例</a><ul><li><a href=#使用-kubebuilderhttpsbookkubebuilderio-开发-operator>使用 <a href=https://book.kubebuilder.io/>Kubebuilder</a> 开发 Operator</a><ul><li><a href=#准备>准备</a></li><li><a href=#对接-k8s>对接 k8s</a></li><li><a href=#开始编码>开始编码</a></li><li><a href=#利用-status-提升可维护性>利用 status 提升可维护性</a></li></ul></li></ul></li></ul></nav></div></div></div></div><div class=hb-blog-post-main><div class="hb-blog-post-content hb-module" data-bs-spy=scroll data-bs-target=#TableOfContents><p>使用过 k8s 的同学可能执行过以下命令：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>kubectl edit sts myapp <span class=c1># 编辑一个名称为 myapp 的 StatefulSet</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>kubectl describe sts myapp <span class=c1># 查看一个名称为 myapp 的 StatefulSet</span>
</span></span></code></pre></div><p>StatefulSet 是 k8s 定义的一种资源，类似的还有 Deployment、Job、ConfigMap 等。当你执行 edit 命令编辑这些资源后，k8s 会通过不停轮询的方式（核心概念：<code>control loop</code>），将目标资源调整（核心概念：<code>reconcile</code>）到你期望的状态。</p><p>例如，你按了空调的遥控器，希望将房间的温度下调到 20℃。空调的压缩机开始工作，并且同时不停的检测当前实际的温度与你期望的温度之间的差异，直到温度达到20℃，这就是一个 control loop 的例子。</p><blockquote><p>很简单，对吧？</p></blockquote><p>设想一下如果不是这样，你将一手拿着温度计，然后不停的告诉空调温度仍然很高，或者已经变得过低了。</p><p>这就是声明式 API 的好处，用户只需要告诉程序你的期望，剩下的交给程序来做（对于程序开发者来说是雷锋行为），而程序实现目标最省力的方式，就是采用 control loop 的方式，不停的对比期望与现实的差距。</p><h2 id=operator-是什么>Operator 是什么</h2><p>试想我们不再满足于 k8s 提供的默认的资源，我们想利用这种省心省力的方式，来管理我们自己的资源，如：数据库的一个用户。</p><p>你可能想说，数据库的用户存在于数据库内，我知道数据库的集群可以定义为 StatefulSet 然后由 k8s 管理，用户又怎么使用 k8s 管理呢？为什么要用 k8s 来管理呢？</p><blockquote><p>为什么要用 k8s 管理用户资源？</p></blockquote><p>以 MySql 为例，通常我们创建用户，是使用 root 用户登录到数据库，执行 sql 语句创建用户。但是设想以下几种场景：</p><ol><li>你不知道 root 用户的密码，或者因为安全要求，不能提供给你</li><li>你不知道 MySql 的 IP</li><li>你知道以上信息，但是因为没有开启相应的节点权限，你无法登录数据库</li><li>你完成了以上所有步骤，结果其中某些登录或者创建步骤失败了，你和数据库运维人员开始扯皮</li></ol><p>看到了吧？这些都是生产环境中，真实会遇到的事情。而使用以下步骤，我们就可以一举解决这些问题。</p><blockquote><p>怎么做到？</p></blockquote><p>把大象关进冰箱需要三步，而我们要使用 Operator 完成在数据库中创建用户只需要两步：</p><ol><li><p>告诉数据库，我需要创建的用户信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln>1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>handsomeguy.cn/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DatabaseUser                        </span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cnhandsomeguy                                 </span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>cnhandsomeguy                </span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>changeit                     </span><span class=w>
</span></span></span></code></pre></div><p>这就是一个最简单的自定义资源（核心概念：<code>custom resource</code>，简称 cr），包含用户名、密码，还有 k8s 资源的一些唯一性信息，如 apiVersion（假如你对自己的定义不满意，新加了一些字段，就需要更改版本号，但是这种做法要坚决避免，后文会提到原因和对策），Kind（就像 StatefulSet 和 Deployment 也是一种 Kind 一样，我们给自己起了一个名字叫 DatabaseUser）</p><p>聪明的同学肯定能看到，这个资源还缺少了一些信息，如需要在哪个数据库创建？密码怎么明文写在这里了呢？我们将在后面的章节完善这些部分。</p></li><li><p>数据库来创建用户</p><p>实际上此时并不是数据库来执行创建用户的动作，而是我们的 Operator。Operator 一直在待命（持续的监控 Kind 为 DatabaseUser 的资源），在我们提交上面的请求后，它就可以连接到数据库，执行创建用户的动作，当然，这部分逻辑需要由我们自己来编写。</p></li></ol><blockquote><p>简单吧！</p></blockquote><p>Operator 是管理 k8s 自定义资源的一种扩展。它也遵循 <code>control loop</code> 的设计理念，通常我们需要在一个 Operator 中，编写一个控制器（核心概念：<code>controller</code>），它是一段代码（废话），这个控制器接收到资源的创建、更新、删除事件，由我们编码来决定：</p><ol><li>如何实现这些创建、更新、删除的逻辑</li><li>检测是否达到了期望，如果返回了错误，则认为需要进入下一次循环，再来一遍！</li></ol><h2 id=看看一个案例>看看一个案例</h2><p>还有一个重要的概念没有介绍：自定义资源的定义（custom resource definition，简称 crd）。有点绕口，但是试着这么理解：</p><ol><li>Operator 是一个进程，一直运行在 k8s 集群内部，监控着某种 Kind 的资源的事件</li><li>它到底在监控什么呢？我们需要一个名字！（Kind）</li><li>如果它监控到了 DatabaseUser，该如何去 spec 中找到用户名、密码这些信息呢？
我们需要一个定义，一个描述文件，来事先告诉 Operator 数据库用户的类型、细节，以便于 Operator 来监控、按照流程执行。</li></ol><p>使用以下命令可以查看当前 k8s 中已经有哪些 crd：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>kubectl get crd
</span></span></code></pre></div><p>所以现在，我们需要以下几种东西：</p><ol><li>资源定义（crd）</li><li>Operator 程序的编码和部署</li><li>资源（cr）</li></ol><blockquote><p>吓到我了，我需要从零开始编码，写一个 Operator 吗？可以用 Java 吗？部署在哪？怎么监控？怎么对接 k8s？</p></blockquote><p>Relax! 有框架，有示例，只要你的 <kbd>Ctrl</kbd> + <kbd>C/V</kbd> 能用就行，可以开始了吗？</p><h3 id=使用-kubebuilderhttpsbookkubebuilderio-开发-operator>使用 <a href=https://book.kubebuilder.io/ target=_blank rel="noopener noreferrer">Kubebuilder</a> 开发 Operator</h3><blockquote><p>有点快了，Kubebuilder 是什么？为什么选它？</p></blockquote><p>还有个选择是 operator-sdk，大同小异，都是生成代码的工具罢了。当然你想手撸也不是不行。</p><p>我建议通篇阅读一下 <a href=https://book.kubebuilder.io/ target=_blank rel="noopener noreferrer">https://book.kubebuilder.io/</a>，但是时间有限的同学，看本文熟悉下脉络就行。本文有个作用是，帮助你避免一些坑，否则你生成的代码很可能是在某些 k8s 版本上跑不起来的。</p><h4 id=准备>准备</h4><ol><li><p>准备一台 linux 虚拟机，并且安装好 gcc 和 make 命令。</p><p>按照 <a href=https://book.kubebuilder.io/quick-start.html#installation target=_blank rel="noopener noreferrer">https://book.kubebuilder.io/quick-start.html#installation</a> 执行命令，下载 kubebuilder。</p></li><li><p>初始化仓库</p><p>按照 <a href=https://book.kubebuilder.io/quick-start.html#create-a-project target=_blank rel="noopener noreferrer">https://book.kubebuilder.io/quick-start.html#create-a-project</a> 执行命令，执行初始化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>kubebuilder init --domain handsomeguy.cn --repo handsomeguy.cn/databaseuser
</span></span></code></pre></div></li><li><p>创建一个 API</p><p>一个 Operator 可以管理多个资源，这些资源可以理解为就是一个 API。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>kubebuilder create api --crd-version v1 --group mygroup --version v1alpha1 --kind DatabaseUser
</span></span></code></pre></div><p>这里注意一下， &ndash;crd-version 从 k8s 1.16 的版本后就不支持 v1beta1 了。
这一步骤会生成一些 go 文件。</p></li><li><p>编辑这些 go 文件。
假设我们要增加用户名和密码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=kd>type</span> <span class=nx>DatabaseUser</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>   <span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span>   <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>   <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span> <span class=s>`json:&#34;metadata&#34;`</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>   <span class=nx>Spec</span>   <span class=nx>DatabaseUserSpec</span>   <span class=s>`json:&#34;spec,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=kd>type</span> <span class=nx>DatabaseUserSpec</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>	  <span class=nx>User</span> <span class=kt>string</span> <span class=s>`json:&#34;user,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>8</span><span class=cl>	  <span class=nx>Password</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>SecretKeySelector</span> <span class=s>`json:&#34;password,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>9</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>编写好了，假设先写这么多。有两点要说明一下：</p><ol><li>上面我们说密码是明文存储的，不安全，这里我们使用了一个 corev1.SecretKeySelector。假设你的密码存储在了某一个名为 my-secret 的卷中的 my-key 字段，我们就可以在后面使用如下方式来取到它的明文。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln>1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>handsomeguy.cn/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DatabaseUser                        </span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cnhandsomeguy                                 </span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>cnhandsomeguy                </span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-secret</span><span class=w>
</span></span></span><span class=line><span class=ln>9</span><span class=cl><span class=w>    </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>my-key                     </span><span class=w>
</span></span></span></code></pre></div><ol start=2><li>用户的定义还可以增加 status 这样的 sub-resource，这样在用户创建失败的时候，将失败的信息刷回到 status 中，就可以使用 kubectl describe 命令来查看失败信息，后文会给案例。</li></ol></li><li><p>生成 crd 文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>make manifests <span class=c1>#在项目的根目录执行 </span>
</span></span></code></pre></div><blockquote><p>重大提醒</p></blockquote><p>根目录中有MakeFile文件，有必要仔细阅读一下。因为 make manifests 步骤会调用一个 controller-gen 的工具，来生成 crd 文件。但是 controller-gen 和 k8s 是有严格的配套关系的。如果你想生成老版本的（k8s 1.12)的 v1beta1 版本的 crd 文件，就必须使用 0.6.2 版本之前的 controller-gen。可以查看其 release 页面 <a href=https://github.com/kubernetes-sigs/controller-tools/releases target=_blank rel="noopener noreferrer">https://github.com/kubernetes-sigs/controller-tools/releases</a> 来确定使用什么版本。
controller-gen 是由 MakeFile 中指定并在 make 过程中自动下载的（你也可以下载好后放到指定位置），如果想要修改 controller-gen 的版本，可以在 MakeFile 的以下位置修改：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>controller-gen: <span class=c1>## Download controller-gen locally if necessary.</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=k>$(</span>call go-get-tool,<span class=k>$(</span>CONTROLLER_GEN<span class=k>)</span>,sigs.k8s.io/controller-tools/cmd/controller-gen@v0.6.2<span class=k>)</span> <span class=c1>#将0.6.2改为你需要的版本</span>
</span></span></code></pre></div></li><li><p>同时生成多个版本的 crd 文件
修改 MakeFile 的以下几行，以同时生成支持新老版本 k8s 的 crd 文件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>CRD_OPTIONS ?<span class=o>=</span> <span class=s2>&#34;crd:crdVersions={v1beta1,v1},trivialVersions=true,preserveUnknownFields=false&#34;</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>manifests: controller-gen <span class=c1>## Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.</span>
</span></span><span class=line><span class=ln>3</span><span class=cl> <span class=k>$(</span>CONTROLLER_GEN<span class=k>)</span> <span class=k>$(</span>CRD_OPTIONS<span class=k>)</span> rbac:roleName<span class=o>=</span>my-crd-manager webhook <span class=nv>paths</span><span class=o>=</span>./... output:crd:artifacts:config<span class=o>=</span>config/crd/bases
</span></span></code></pre></div><p>实际执行的命令其实是，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>bin/controller-gen rbac:roleName<span class=o>=</span>my-crd-manager crd:crdVersions<span class=o>={</span>v1,v1beta1<span class=o>}</span> webhook <span class=nv>paths</span><span class=o>=</span>./... output:crd:artifacts:config<span class=o>=</span>config/crd/ bases
</span></span></code></pre></div><p>因此你也可以手动执行。</p></li><li><p>在 k8s cluster 中创建这个 crd
在进行这一步之前，你可以微调你的 crd，比如调整它的缩写为 dbu，这样就可以执行 <code>kubectl get dbu</code> 来查看你的资源。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apiextensions.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CustomResourceDefinition</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=nt>controller-gen.kubebuilder.io/version</span><span class=p>:</span><span class=w> </span><span class=l>v0.6.2</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>    </span><span class=nt>&#34;helm.sh/resource-policy&#34;: </span><span class=l>keep</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>databaseuserss.handsomeguy.cn</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>  </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>mygroup.handsomeguy.cn</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>  </span><span class=nt>names</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DatabaseUser</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>    </span><span class=nt>listKind</span><span class=p>:</span><span class=w> </span><span class=l>DatabaseUserList</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=nt>plural</span><span class=p>:</span><span class=w> </span><span class=l>databaseusers</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=nt>singular</span><span class=p>:</span><span class=w> </span><span class=l>databaseuser</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=nt>shortNames</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>dbu]</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>  </span><span class=nt>preserveUnknownFields</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>  </span><span class=nt>scope</span><span class=p>:</span><span class=w> </span><span class=l>Namespaced</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>  </span><span class=nt>versions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>  </span><span class=l>// ... 省略</span><span class=w>
</span></span></span></code></pre></div><p>使用以下命令创建并查看 crd。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>kubectl apply -f my-crd.yaml
</span></span><span class=line><span class=ln>2</span><span class=cl>kubectl get crd
</span></span></code></pre></div></li></ol><p>到这里，准备工作就做完了（不出意外，你会在 make manifests 的时候遇到很多报错，请耐心查看报错，一一思考解决，都是有迹可循的。）。
我们现在有了</p><ol><li>crd</li><li>代码
此时可以观察一下生成的代码，如 DatabaseUserController 的 Reconcile 方法，这里将是你编码的主要阵地。
还差亿点点小细节，就可以编写 cr 文件并部署测试了。</li></ol><h4 id=对接-k8s>对接 k8s</h4><p>首先我们应该对接 k8s，不然怎么知道我们的 operator 是否能正常监听到资源呢？
查看 sigs.k8s.io/controller-runtime/pkg/client/config/config.go 的源码，应该是有很多中配置的方式，我们选择最简单的一种：指定 KUBECONFIG 变量。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>    </span><span class=nt>insecure-skip-tls-verify</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=nt>certificate-authority</span><span class=p>:</span><span class=w> </span>{{<span class=l>CA_DIR}}/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://{{KUBERNETES_MASTER}}</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cluster</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span>- <span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=nt>client-certificate</span><span class=p>:</span><span class=w> </span>{{<span class=l>CA_DIR}}/kubecfg.crt</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=nt>client-key-data</span><span class=p>:</span><span class=w> </span>{{<span class=l>CLIENT_KEY}}</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>user</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>cluster</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>user</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>defaultContext</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>defaultContext</span><span class=w>
</span></span></span></code></pre></div><p>这个配置不是开箱即用的，多想一想怎么获取到这些证书吧，我写本文的时候手头没有 k8s 集群，暂不能提供方法了。</p><p>配置好后，在你的 go 程序运行的时候指定或在开发过程中在 goland 配置都可以，具体方式不再赘述。</p><h4 id=开始编码>开始编码</h4><ol><li><p>监控指定 namespace 的资源</p><p>operator 可以监控一个或多个 k8s namespace 下的资源。在 main.go 中找到如下位置，修改即可：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=nx>mgrOptions</span> <span class=o>:=</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Options</span><span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>   <span class=nx>Scheme</span><span class=p>:</span>                 <span class=nx>scheme</span><span class=p>,</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>   <span class=nx>MetricsBindAddress</span><span class=p>:</span>     <span class=nx>setup</span><span class=p>.</span><span class=nx>MetricsAddr</span><span class=p>,</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>   <span class=nx>HealthProbeBindAddress</span><span class=p>:</span> <span class=nx>setup</span><span class=p>.</span><span class=nx>ProbeAddr</span><span class=p>,</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>   <span class=nx>NewCache</span><span class=p>:</span>               <span class=nx>cache</span><span class=p>.</span><span class=nf>MultiNamespacedCacheBuilder</span><span class=p>(</span><span class=nx>your_name_spaces</span><span class=p>),</span> <span class=c1>// 在此处指定需要监控的 namespace，实际生产过程中这些都是要做成可配置的，或通过启动参数指定
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=ln>7</span><span class=cl><span class=nx>mgr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nf>NewManager</span><span class=p>(</span><span class=nx>cfg</span><span class=p>,</span> <span class=nx>mgrOptions</span><span class=p>)</span>
</span></span></code></pre></div></li><li><p>监控要创建到某个数据库的资源</p><p>可以利用 k8s 资源的 label。如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>handsomeguy.cn/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DatabaseUser                        </span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>label</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>    </span><span class=nt>target</span><span class=p>:</span><span class=w> </span><span class=l>that-database</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cnhandsomeguy                                 </span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>cnhandsomeguy                </span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-secret</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>my-key   </span><span class=w>
</span></span></span></code></pre></div><p>这样我们就可以在 DatabaseUserController 中过滤出要创建到指定数据库的资源，其它数据库的资源都不管。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span> <span class=nf>GetLabelEventFilter</span><span class=p>(</span><span class=nx>label</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>value</span> <span class=kt>string</span><span class=p>)</span> <span class=nx>predicate</span><span class=p>.</span><span class=nx>Predicate</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>	  <span class=k>return</span> <span class=nx>predicate</span><span class=p>.</span><span class=nx>Funcs</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>	  	<span class=nx>UpdateFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>event</span> <span class=nx>event</span><span class=p>.</span><span class=nx>UpdateEvent</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>	  		<span class=k>return</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>ObjectOld</span><span class=p>.</span><span class=nf>GetLabels</span><span class=p>()[</span><span class=err>&#39;</span><span class=nx>target</span><span class=err>&#39;</span><span class=p>])</span> <span class=o>==</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>	  	<span class=p>},</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>	  	<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>deleteEvent</span> <span class=nx>event</span><span class=p>.</span><span class=nx>DeleteEvent</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>	  		<span class=k>return</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>deleteEvent</span><span class=p>.</span><span class=nx>Object</span><span class=p>.</span><span class=nf>GetLabels</span><span class=p>()[</span><span class=err>&#39;</span><span class=nx>target</span><span class=err>&#39;</span><span class=p>])</span> <span class=o>==</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>	  	<span class=p>},</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>	  	<span class=nx>CreateFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>createEvent</span> <span class=nx>event</span><span class=p>.</span><span class=nx>CreateEvent</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>	  		<span class=k>return</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>createEvent</span><span class=p>.</span><span class=nx>Object</span><span class=p>.</span><span class=nf>GetLabels</span><span class=p>()[</span><span class=err>&#39;</span><span class=nx>target</span><span class=err>&#39;</span><span class=p>])</span> <span class=o>==</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>	  	<span class=p>},</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>	  	<span class=nx>GenericFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>genericEvent</span> <span class=nx>event</span><span class=p>.</span><span class=nx>GenericEvent</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>	  		<span class=k>return</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>genericEvent</span><span class=p>.</span><span class=nx>Object</span><span class=p>.</span><span class=nf>GetLabels</span><span class=p>()[</span><span class=err>&#39;</span><span class=nx>target</span><span class=err>&#39;</span><span class=p>])</span> <span class=o>==</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>	  	<span class=p>},</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>	  <span class=p>}</span>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=c1>// SetupWithManager 方法由 kubebuilder 生成
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>DatabaseUserReconciler</span><span class=p>)</span> <span class=nf>SetupWithManager</span><span class=p>(</span><span class=nx>mgr</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Manager</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>mgr</span><span class=p>.</span><span class=nf>GetFieldIndexer</span><span class=p>().</span><span class=nf>IndexField</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>       <span class=c1>// ... 省略
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=nx>logger</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;setup with manager, %s, %s&#34;</span><span class=p>,</span> <span class=nx>constants</span><span class=p>.</span><span class=nx>CrLabelKey</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Opts</span><span class=p>.</span><span class=nx>Target</span><span class=p>)</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nf>NewControllerManagedBy</span><span class=p>(</span><span class=nx>mgr</span><span class=p>).</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>    	  <span class=nf>For</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>DatabaseUser</span><span class=p>{}).</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>    	  <span class=nf>WithEventFilter</span><span class=p>(</span><span class=nf>GetLabelEventFilter</span><span class=p>(</span><span class=nx>constants</span><span class=p>.</span><span class=nx>CrLabelKey</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Opts</span><span class=p>.</span><span class=nx>Target</span><span class=p>)).</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>    	  <span class=nf>Owns</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>DatabaseUser</span><span class=p>{}).</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>    	  <span class=nf>Complete</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>        <span class=c1>// ... 省略
</span></span></span></code></pre></div></li><li><p>Reconcile 方法的编写</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>DatabaseUserReconciler</span><span class=p>)</span> <span class=nf>Reconcile</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>	   <span class=c1>// get user from cluster
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c1></span>	   <span class=kd>var</span> <span class=nx>DatabaseUser</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>DatabaseUser</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>	   <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>DatabaseUser</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>	   	   <span class=nx>logger</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to fetch DatabaseUser: %v.&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>	   	   <span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>client</span><span class=p>.</span><span class=nf>IgnoreNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>	   <span class=p>}</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl>	   <span class=c1>// 处理用户的删除事件
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=c1></span>	   <span class=k>if</span> <span class=p>!</span><span class=nx>DatabaseUser</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>.</span><span class=nx>DeletionTimestamp</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>	   	   <span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>r</span><span class=p>.</span><span class=nb>delete</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>DatabaseUser</span><span class=p>)</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>	   <span class=p>}</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl>	   <span class=nx>logger</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s before update %s.&#34;</span><span class=p>,</span> <span class=nx>DatabaseUser</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>DatabaseUser</span><span class=p>.</span><span class=nx>ResourceVersion</span><span class=p>)</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>	   <span class=nx>oldStatus</span> <span class=o>:=</span> <span class=nx>DatabaseUser</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nf>DeepCopy</span><span class=p>()</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>	   <span class=c1>// 用户创建、更新等逻辑编写。可以调用 job 或者直接在 go 中连接本地数据库进行用户操作。
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=c1></span>	   <span class=nx>reconcileError</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>do</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>DatabaseUser</span><span class=p>)</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=c1>// 将实际状态刷新到资源中
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=c1></span>	   <span class=nx>updateStatusError</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>updateStatus</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>DatabaseUser</span><span class=p>,</span> <span class=nx>oldStatus</span><span class=p>)</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=c1>// 在以下方法中判断成功还是失败，并决策是否进行下一轮循环
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=c1></span>	   <span class=k>return</span> <span class=nf>againOrDone</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>DatabaseUser</span><span class=p>,</span> <span class=nx>reconcileError</span><span class=p>,</span> <span class=nx>updateStatusError</span><span class=p>)</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Reconcile 返回两个结果：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=k>return</span> <span class=nx>reconcile</span><span class=p>.</span><span class=nx>Result</span><span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl> 		<span class=nx>Requeue</span><span class=p>:</span>      <span class=kc>true</span><span class=p>,</span> <span class=c1>// 重新开始下次循环
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1></span> 		<span class=nx>RequeueAfter</span><span class=p>:</span> <span class=nx>requeueAfter</span><span class=p>,</span>
</span></span><span class=line><span class=ln>4</span><span class=cl> 	<span class=p>},</span> <span class=nx>err</span> <span class=c1>// err 不为 nil 的时候也重新开始下次循环
</span></span></span></code></pre></div></li><li><p>如何从 secret 中获取密码</p><p>示例代码，可以参考如下，实际实现还需要考虑很多健壮性和扩展性。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>DatabaseUserReconciler</span><span class=p>)</span> <span class=nf>GetPasswordInCluster</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>user</span> <span class=o>*</span><span class=nx>v1alpha1</span><span class=p>.</span><span class=nx>DatabaseUser</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=nx>secret</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Secret</span><span class=p>{}</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=nx>secretKey</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>ObjectKey</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Password</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Namespace</span><span class=p>:</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>}</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>secretKey</span><span class=p>,</span> <span class=nx>secret</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    	   <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=kd>var</span> <span class=nx>path</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Password</span><span class=p>.</span><span class=nx>Key</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=k>return</span> <span class=nb>string</span><span class=p>(</span><span class=nx>sec</span><span class=p>.</span><span class=nx>Data</span><span class=p>[</span><span class=nx>path</span><span class=p>])</span>
</span></span><span class=line><span class=ln>10</span><span class=cl> <span class=p>}</span>
</span></span></code></pre></div></li><li><p>finalizer 实现同步删除资源</p><p>当你执行 <code>kubectl delete dbu my-user</code> 的时候，我们希望 k8s 等待 operatoror 执行完成并返回删除用户成功后，才真的删除这个 cr 文件。这样就需要用到 finalizer的能力。见官方文档：<a href=https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/finalizers/ target=_blank rel="noopener noreferrer">https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/finalizers/</a>。</p><p>代码中，可以这么实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl>	<span class=c1>// finalizer is pre-delete hook
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span>    <span class=nx>myFinalizer</span> <span class=p>=</span> <span class=s>&#34;mygroup.handsomeguy.cn/databaseuser&#34;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=c1>// 在新增用户的时候，打上 finalizer 标记，使用 kubectl get dbu 可以看到 finalizer 的信息
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>controllerutil</span><span class=p>.</span><span class=nf>ContainsFinalizer</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>myFinalizer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>		<span class=nx>controllerutil</span><span class=p>.</span><span class=nf>AddFinalizer</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>myFinalizer</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=c1>// 在删除用户的时候，如果删除成功就去除这个 finalizer
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>controllerutil</span><span class=p>.</span><span class=nf>ContainsFinalizer</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>myFinalizer</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>r</span><span class=p>.</span><span class=nx>Opts</span><span class=p>.</span><span class=nx>SkipUpdateStatus</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=c1>// 先删除用户
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>DeleteUser</span><span class=p>(</span><span class=nx>user</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        <span class=c1>// 再去除阻塞器 finalizer
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=c1></span>		<span class=nx>controllerutil</span><span class=p>.</span><span class=nf>RemoveFinalizer</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=nx>myFinalizer</span><span class=p>)</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>		<span class=c1>// update to delete finalizer
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>user</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>	<span class=p>}</span>
</span></span></code></pre></div></li></ol><h4 id=利用-status-提升可维护性>利用 status 提升可维护性</h4><p>区分一个程序员水平的一个方法，是看他的代码非功能性指标如何，如可维护性高不高，出现问题定位问题快不快。我们这个 operator 说实话还是蛮复杂的，出现问题没有经验的人还真的不好定位。我们需要一种便捷的手段，一条命令就可以定位大部分问题。对于用户来说，熟悉的可能只有 <code>kubectl get dbu</code> 的命令，我们可不可以将创建用户过程中的报错放到这个结果里面呢？答案是可以。</p><p>文档在这里。<a href=https://book-v1.book.kubebuilder.io/basics/status_subresource.html target=_blank rel="noopener noreferrer">https://book-v1.book.kubebuilder.io/basics/status_subresource.html</a>，但是不如直接看代码：</p><ol><li><p>在 xxxxtypes.go 中增加 status
当然你也可以按照官方的文档去增加生成代码的注解。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=c1>//+kubebuilder:object:root=true
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1>//+kubebuilder:subresource:status
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=c1>// DatabaseUser is the Schema for the DatabaseUsers API
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>DatabaseUser</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>   <span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span>   <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>   <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span> <span class=s>`json:&#34;metadata&#34;`</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl>   <span class=nx>Spec</span>   <span class=nx>DatabaseUserSpec</span>   <span class=s>`json:&#34;spec,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>   <span class=nx>Status</span> <span class=nx>DatabaseUserStatus</span> <span class=s>`json:&#34;status,omitempty&#34;`</span> <span class=c1>// 新增部分
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=c1>// DatabaseUserStatus defines the observed state of DatabaseUser
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>DatabaseUserStatus</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>   <span class=nx>Conditions</span>     <span class=p>[]</span><span class=nx>DatabaseUserCondition</span> <span class=s>`json:&#34;conditions,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>   <span class=c1>// 其它想放的字段，省略
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=c1>// DatabaseUserConditionType custom type
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>DatabaseUserConditionType</span> <span class=kt>string</span>
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=c1>// DatabaseUserCondition v3 condition
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>DatabaseUserCondition</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>	  <span class=c1>// Type of user condition.
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=c1></span>	  <span class=nx>Type</span> <span class=nx>DatabaseUserConditionType</span> <span class=s>`json:&#34;type,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>	  <span class=c1>// Status of the condition, one of True, False, Unknown.
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=c1></span>	  <span class=nx>Status</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>ConditionStatus</span> <span class=s>`json:&#34;status,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>	  <span class=c1>// The last time this condition was updated.
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=c1></span>	  <span class=nx>LastUpdateTime</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Time</span> <span class=s>`json:&#34;lastUpdateTime,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>	  <span class=c1>// Last time the condition transitioned from one status to another.
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=c1></span>	  <span class=nx>LastTransitionTime</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>Time</span> <span class=s>`json:&#34;lastTransitionTime,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>	  <span class=c1>// The reason for the condition&#39;s last transition.
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=c1></span>	  <span class=nx>Reason</span> <span class=kt>string</span> <span class=s>`json:&#34;reason,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>	  <span class=c1>// A human readable message indicating details about the transition.
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=c1></span>	  <span class=nx>Message</span> <span class=kt>string</span> <span class=s>`json:&#34;message,omitempty&#34;`</span>
</span></span><span class=line><span class=ln>33</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>
</span></span><span class=line><span class=ln>35</span><span class=cl><span class=c1>// UpdateStatusCondition update status condition
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>DatabaseUser</span><span class=p>)</span> <span class=nf>UpdateStatusCondition</span><span class=p>(</span><span class=nx>condType</span> <span class=nx>DatabaseUserConditionType</span><span class=p>,</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>	   <span class=nx>status</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>ConditionStatus</span><span class=p>,</span> <span class=nx>reason</span><span class=p>,</span> <span class=nx>message</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>cond</span> <span class=o>*</span><span class=nx>DatabaseUserCondition</span><span class=p>,</span> <span class=nx>changed</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>	   <span class=nx>t</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nf>NewTime</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>	   <span class=nx>existedCondition</span><span class=p>,</span> <span class=nx>exists</span> <span class=o>:=</span> <span class=nx>u</span><span class=p>.</span><span class=nf>ConditionExists</span><span class=p>(</span><span class=nx>condType</span><span class=p>)</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>	   <span class=k>if</span> <span class=p>!</span><span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>	       <span class=nx>newCondition</span> <span class=o>:=</span> <span class=nx>DatabaseUserCondition</span><span class=p>{</span>
</span></span><span class=line><span class=ln>42</span><span class=cl>	      	   <span class=nx>Type</span><span class=p>:</span> <span class=nx>condType</span><span class=p>,</span> <span class=nx>Status</span><span class=p>:</span> <span class=nx>status</span><span class=p>,</span> <span class=nx>Reason</span><span class=p>:</span> <span class=nx>reason</span><span class=p>,</span> <span class=nx>Message</span><span class=p>:</span> <span class=nx>message</span><span class=p>,</span>
</span></span><span class=line><span class=ln>43</span><span class=cl>	      	   <span class=nx>LastTransitionTime</span><span class=p>:</span> <span class=nx>t</span><span class=p>,</span> <span class=nx>LastUpdateTime</span><span class=p>:</span> <span class=nx>t</span><span class=p>,</span>
</span></span><span class=line><span class=ln>44</span><span class=cl>	       <span class=p>}</span>
</span></span><span class=line><span class=ln>45</span><span class=cl>	   	   <span class=nx>u</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Conditions</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>u</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Conditions</span><span class=p>,</span> <span class=nx>newCondition</span><span class=p>)</span>
</span></span><span class=line><span class=ln>46</span><span class=cl>
</span></span><span class=line><span class=ln>47</span><span class=cl>	   	   <span class=k>return</span> <span class=o>&amp;</span><span class=nx>newCondition</span><span class=p>,</span> <span class=kc>true</span>
</span></span><span class=line><span class=ln>48</span><span class=cl>	   <span class=p>}</span>
</span></span><span class=line><span class=ln>49</span><span class=cl>
</span></span><span class=line><span class=ln>50</span><span class=cl>	   <span class=k>if</span> <span class=nx>status</span> <span class=o>!=</span> <span class=nx>existedCondition</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>51</span><span class=cl>	   	   <span class=nx>existedCondition</span><span class=p>.</span><span class=nx>LastTransitionTime</span> <span class=p>=</span> <span class=nx>t</span>
</span></span><span class=line><span class=ln>52</span><span class=cl>	   	   <span class=nx>changed</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=ln>53</span><span class=cl>	   <span class=p>}</span>
</span></span><span class=line><span class=ln>54</span><span class=cl>
</span></span><span class=line><span class=ln>55</span><span class=cl>	   <span class=k>if</span> <span class=nx>message</span> <span class=o>!=</span> <span class=nx>existedCondition</span><span class=p>.</span><span class=nx>Message</span> <span class=o>||</span> <span class=nx>reason</span> <span class=o>!=</span> <span class=nx>existedCondition</span><span class=p>.</span><span class=nx>Reason</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>56</span><span class=cl>	   	   <span class=nx>existedCondition</span><span class=p>.</span><span class=nx>LastUpdateTime</span> <span class=p>=</span> <span class=nx>t</span>
</span></span><span class=line><span class=ln>57</span><span class=cl>	   	   <span class=nx>changed</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=ln>58</span><span class=cl>	   <span class=p>}</span>
</span></span><span class=line><span class=ln>59</span><span class=cl>
</span></span><span class=line><span class=ln>60</span><span class=cl>	   <span class=nx>existedCondition</span><span class=p>.</span><span class=nx>Status</span> <span class=p>=</span> <span class=nx>status</span>
</span></span><span class=line><span class=ln>61</span><span class=cl>	   <span class=nx>existedCondition</span><span class=p>.</span><span class=nx>Message</span> <span class=p>=</span> <span class=nx>message</span>
</span></span><span class=line><span class=ln>62</span><span class=cl>	   <span class=nx>existedCondition</span><span class=p>.</span><span class=nx>Reason</span> <span class=p>=</span> <span class=nx>reason</span>
</span></span><span class=line><span class=ln>63</span><span class=cl>
</span></span><span class=line><span class=ln>64</span><span class=cl>	   <span class=k>return</span> <span class=nx>existedCondition</span><span class=p>,</span> <span class=nx>changed</span>
</span></span><span class=line><span class=ln>65</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>加的代码有点多，类爆炸了，但是是值得的。</p></li><li><p>在成功或失败的地方（DatabaseUserController中），调用 UpdateStatusCondition</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=nx>user</span><span class=p>.</span><span class=nf>UpdateStatusCondition</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>	   <span class=s>&#34;Ready&#34;</span><span class=p>,</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>ConditionTrue</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>	   <span class=s>&#34;Provision Succeeded&#34;</span><span class=p>,</span> <span class=s>&#34;The user provisioning has succeeded.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=p>)</span>      
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=k>if</span> <span class=o>*</span><span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>	   <span class=nx>user</span><span class=p>.</span><span class=nf>UpdateStatusCondition</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>	   	<span class=s>&#34;NotReady&#34;</span><span class=p>,</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>ConditionFalse</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>	   	<span class=s>&#34;Provision Failed&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;The user provisioning has failed: %s&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>err</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>	   <span class=p>)</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>最后在 Reconcile 方法中刷回状态即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>DatabaseUserReconciler</span><span class=p>)</span> <span class=nf>Reconcile</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=c1>// ... 省略
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1></span>    <span class=nx>reconcileError</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>do</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>DatabaseUser</span><span class=p>)</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=nx>updateStatusError</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>updateStatus</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>DatabaseUser</span><span class=p>,</span> <span class=nx>oldStatus</span><span class=p>)</span> <span class=c1>// 刷回状态到集群
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nf>againOrDone</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>DatabaseUser</span><span class=p>,</span> <span class=nx>reconcileError</span><span class=p>,</span> <span class=nx>updateStatusError</span><span class=p>)</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>    <span class=c1>// ... 省略
</span></span></span></code></pre></div><p>如此，只有你在 controller 的全阶段，将 err 信息写入到 cr 中，用户就可以使用 <code>kubectl describe dbu</code> 来看到这些报错信息，而不用麻烦你了。</p></li></ol><p>好了，以上就是一些实现一个 Operator 的步骤了。这些内容大部分靠回忆，代码部分都是网上找的伪代码，还有很多实战中的坑需要注意，但是限于时间太久，已经想不起来了，以后想起来再补充吧。大家有什么想法可以在评论区交流哦！</p></div><div class=hb-module><div class="hb-social-share-buttons d-flex flex-wrap align-items-center gap-2 justify-content-center"><a class="hb-social-share-button hb-social-share-button-twitter text-decoration-none d-flex align-items-center" target=_blank title=推特 href="https://twitter.com/intent/tweet?url=https%3A%2F%2Ftravisbikkle.github.io%2F2022%2F05%2Foperator-dev%2F&amp;text=%E5%A6%82%E4%BD%95%E5%86%99%E4%B8%80%E4%B8%AA+K8s+Operator"><svg aria-hidden="true" class="hi-svg-inline hb-social-share-button-icon me-1" fill="currentcolor" height="1.25em" role="img" style="color:#000" viewBox="0 0 24 24" width="1.25em" xmlns="http://www.w3.org/2000/svg"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932zM17.61 20.644h2.039L6.486 3.24H4.298z"/></svg><span class=hb-social-share-button-label>推特</span>
</a><a class="hb-social-share-button hb-social-share-button-facebook text-decoration-none d-flex align-items-center" target=_blank title=脸书 href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Ftravisbikkle.github.io%2F2022%2F05%2Foperator-dev%2F"><svg aria-hidden="true" class="hi-svg-inline hb-social-share-button-icon me-1" fill="currentcolor" height="1.25em" role="img" style="color:#0866ff" viewBox="0 0 24 24" width="1.25em" xmlns="http://www.w3.org/2000/svg"><title>Facebook</title><path d="M9.101 23.691v-7.98H6.627v-3.667h2.474v-1.58c0-4.085 1.848-5.978 5.858-5.978.401.0.955.042 1.468.103a8.68 8.68.0 011.141.195v3.325a8.623 8.623.0 00-.653-.036 26.805 26.805.0 00-.733-.009c-.707.0-1.259.096-1.675.309a1.686 1.686.0 00-.679.622c-.258.42-.374.995-.374 1.752v1.297h3.919l-.386 2.103-.287 1.564h-3.246v8.245C19.396 23.238 24 18.179 24 12.044c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.628 3.874 10.35 9.101 11.647z"/></svg><span class=hb-social-share-button-label>脸书</span>
</a><a class="hb-social-share-button hb-social-share-button-linkedin text-decoration-none d-flex align-items-center" target=_blank title=领英 href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ftravisbikkle.github.io%2F2022%2F05%2Foperator-dev%2F"><svg aria-hidden="true" class="hi-svg-inline hb-social-share-button-icon me-1" fill="currentcolor" height="1.25em" role="img" style="color:#0a66c2" viewBox="0 0 24 24" width="1.25em" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg><span class=hb-social-share-button-label>领英</span>
</a><a class="hb-social-share-button hb-social-share-button-sinaweibo text-decoration-none d-flex align-items-center" target=_blank title=微博 href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Ftravisbikkle.github.io%2F2022%2F05%2Foperator-dev%2F&amp;title=%E5%A6%82%E4%BD%95%E5%86%99%E4%B8%80%E4%B8%AA+K8s+Operator"><svg aria-hidden="true" class="hi-svg-inline hb-social-share-button-icon me-1" fill="currentcolor" height="1.25em" role="img" style="color:#e6162d" viewBox="0 0 24 24" width="1.25em" xmlns="http://www.w3.org/2000/svg"><title>Sina Weibo</title><path d="M10.098 20.323c-3.977.391-7.414-1.406-7.672-4.02-.259-2.609 2.759-5.047 6.74-5.441 3.979-.394 7.413 1.404 7.671 4.018.259 2.6-2.759 5.049-6.737 5.439l-.002.004zM9.05 17.219c-.384.616-1.208.884-1.829.602-.612-.279-.793-.991-.406-1.593.379-.595 1.176-.861 1.793-.601.622.263.82.972.442 1.592zm1.27-1.627c-.141.237-.449.353-.689.253-.236-.09-.313-.361-.177-.586.138-.227.436-.346.672-.24.239.09.315.36.18.601l.014-.028zm.176-2.719c-1.893-.493-4.033.45-4.857 2.118-.836 1.704-.026 3.591 1.886 4.21 1.983.64 4.318-.341 5.132-2.179.8-1.793-.201-3.642-2.161-4.149zm7.563-1.224c-.346-.105-.57-.18-.405-.615.375-.977.42-1.804.0-2.404-.781-1.112-2.915-1.053-5.364-.03.0.0-.766.331-.571-.271.376-1.217.315-2.224-.27-2.809-1.338-1.337-4.869.045-7.888 3.08C1.309 10.87.0 13.273.0 15.348c0 3.981 5.099 6.395 10.086 6.395 6.536.0 10.888-3.801 10.888-6.82.0-1.822-1.547-2.854-2.915-3.284v.01zm1.908-5.092c-.766-.856-1.908-1.187-2.96-.962-.436.09-.706.511-.616.932.09.42.511.691.932.602.511-.105 1.067.044 1.442.465.376.421.466.977.316 1.473-.136.406.089.856.51.992.405.119.857-.105.992-.512.33-1.021.12-2.178-.646-3.035l.03.045zm2.418-2.195c-1.576-1.757-3.905-2.419-6.054-1.968-.496.104-.812.587-.706 1.081.104.496.586.813 1.082.707 1.532-.331 3.185.15 4.296 1.383 1.112 1.246 1.429 2.943.947 4.416-.165.48.106 1.007.586 1.157.479.165.991-.104 1.157-.586.675-2.088.241-4.478-1.338-6.235l.03.045z"/></svg><span class=hb-social-share-button-label>微博</span></a></div></div><div class="hb-content-panel-wrapper position-sticky mb-4 d-flex justify-content-center"><div class="hb-content-panel d-flex shadow w-auto rounded-5 bg-body"><div class="hb-content-panel-item hb-content-panel-translations dropup-center dropup"><button class="btn btn-link text-body" type=button data-bs-toggle=dropdown title=译文 aria-expanded=false><svg aria-hidden="true" class="bi bi-translatebi bi-translate hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286zm1.634-.736L5.5 3.956h-.049l-.679 2.022z"/><path d="M0 2a2 2 0 012-2h7a2 2 0 012 2v3h3a2 2 0 012 2v7a2 2 0 01-2 2H7a2 2 0 01-2-2v-3H2A2 2 0 010 9zm2-1A1 1 0 001 2v7a1 1 0 001 1h7a1 1 0 001-1V2A1 1 0 009 1zm7.138 9.995q.289.451.63.846c-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6 6 0 01-.415-.492 2 2 0 01-.94.31"/></svg></button><ul class=dropdown-menu><li><a class=dropdown-item href=https://travisbikkle.github.io/zh-hant/2022/05/operator-dev/>繁體中文</a></li></ul></div><div class=hb-content-panel-item><a href=#content-comments class="btn btn-link text-body" title=评论 role=button><svg aria-hidden="true" class="bi bi-chat-dotsbi bi-chat-dots hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M5 8A1 1 0 113 8a1 1 0 012 0m4 0A1 1 0 117 8a1 1 0 012 0m3 1a1 1 0 100-2 1 1 0 000 2"/><path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9 9 0 008 15c4.418.0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.4 10.4.0 01-.524 2.318l-.003.011a11 11 0 01-.244.637c-.079.186.074.394.273.362a22 22 0 00.693-.125m.8-3.108a1 1 0 00-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6-3.004 6-7 6a8 8 0 01-2.088-.272 1 1 0 00-.711.074c-.387.196-1.24.57-2.634.893a11 11 0 00.398-2"/></svg></a></div><div class="hb-content-panel-item hb-content-panel-repo dropup-center dropup"><button class="btn btn-link text-body" type=button title=编辑 data-bs-toggle=dropdown aria-expanded=false><svg aria-hidden="true" class="bi bi-pencil-squarebi bi-pencil-square hi-svg-inline" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M15.502 1.94a.5.5.0 010 .706L14.459 3.69l-2-2L13.502.646a.5.5.0 01.707.0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5.0 00-.121.196l-.805 2.414a.25.25.0 00.316.316l2.414-.805a.5.5.0 00.196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5.0 002.5 15h11a1.5 1.5.0 001.5-1.5v-6a.5.5.0 00-1 0v6a.5.5.0 01-.5.5h-11a.5.5.0 01-.5-.5v-11a.5.5.0 01.5-.5H9a.5.5.0 000-1H2.5A1.5 1.5.0 001 2.5z"/></svg></button><ul class=dropdown-menu><li><a class=dropdown-item href=https://github.com/travisbikkle/travisbikkle.github.io/edit/main/content/posts/code/k8s/2022-05-26-operator-dev.zh-hans.md target=_blank rel="noreferrer noopener"><svg aria-hidden="true" class="bi bi-pencilbi bi-pencil hi-svg-inline me-2" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12.146.146a.5.5.0 01.708.0l3 3a.5.5.0 010 .708l-10 10a.5.5.0 01-.168.11l-5 2a.5.5.0 01-.65-.65l2-5a.5.5.0 01.11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5.0 01.5.5v.5h.5a.5.5.0 01.5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5.0 015 12.5V12h-.5a.5.5.0 01-.5-.5V11h-.5a.5.5.0 01-.468-.325"/></svg>编辑本页</a></li><li><a class=dropdown-item href=https://github.com/travisbikkle/travisbikkle.github.io/blob/main/content/posts/code/k8s/2022-05-26-operator-dev.zh-hans.md target=_blank rel="noreferrer noopener"><svg aria-hidden="true" class="bi bi-eyebi bi-eye hi-svg-inline me-2" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 011.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0114.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 011.172 8z"/><path d="M8 5.5a2.5 2.5.0 100 5 2.5 2.5.0 000-5M4.5 8a3.5 3.5.0 117 0 3.5 3.5.0 01-7 0"/></svg>查看页面源码</a></li><li><a class=dropdown-item href=https://github.com/travisbikkle/travisbikkle.github.io/commit/ba51147adb2cf52abddd5d10e913e978e3886740 target=_blank rel="noreferrer noopener"><svg aria-hidden="true" class="bi bi-gitbi bi-git hi-svg-inline me-2" fill="currentcolor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M15.698 7.287 8.712.302a1.03 1.03.0 00-1.457.0l-1.45 1.45 1.84 1.84a1.223 1.223.0 011.55 1.56l1.773 1.774a1.224 1.224.0 011.267 2.025 1.226 1.226.0 01-2.002-1.334L8.58 5.963v4.353a1.226 1.226.0 11-1.008-.036V5.887a1.226 1.226.0 01-.666-1.608L5.093 2.465.303 7.255a1.03 1.03.0 000 1.457l6.986 6.986a1.03 1.03.0 001.457.0l6.953-6.953a1.03 1.03.0 000-1.457"/></svg>优化主页面，增加各种分类，标签</a></li></ul></div></div></div><ul class="hb-blog-post-nav nav justify-content-between hb-module"><li class="nav-item my-1"><a class="nav-link p-0 d-flex align-items-center text-break" href=/2022/02/vrrp-cap/><svg aria-hidden="true" class="bi bi-arrow-left-circlebi bi-arrow-left-circle hi-svg-inline me-2" fill="currentcolor" height="1.5em" viewBox="0 0 16 16" width="1.5em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1 8a7 7 0 1014 0A7 7 0 001 8m15 0A8 8 0 110 8a8 8 0 0116 0m-4.5-.5a.5.5.0 010 1H5.707l2.147 2.146a.5.5.0 01-.708.708l-3-3a.5.5.0 010-.708l3-3a.5.5.0 11.708.708L5.707 7.5z"/></svg>vrrp 报文抓包的方法</a></li><li class="nav-item my-1"><a class="nav-link p-0 d-flex align-items-center text-break" href=/2023/02/port-forward/>端口转发的一些方法<svg aria-hidden="true" class="bi bi-arrow-right-circlebi bi-arrow-right-circle hi-svg-inline ms-2" fill="currentcolor" height="1.5em" viewBox="0 0 16 16" width="1.5em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1 8a7 7 0 1014 0A7 7 0 001 8m15 0A8 8 0 110 8a8 8 0 0116 0M4.5 7.5a.5.5.0 000 1h5.793l-2.147 2.146a.5.5.0 00.708.708l3-3a.5.5.0 000-.708l-3-3a.5.5.0 10-.708.708L10.293 7.5z"/></svg></a></li></ul><div id=content-comments class="hb-blog-post-comments hb-module mb-3"><div class=giscus></div></div></div></div></div><div class="hb-blog-sidebar pe-lg-1"><div class="hb-blog-sidebar-profile hb-module d-flex flex-column justify-content-center align-items-center"><picture><source srcset=/images/logo_hub7ff5b15a111a79c0ee3a783e6fa4fdd_94335_eea4590c4274f5c66eb2ed422639b407.webp type=image/webp><img class="hb-blog-sidebar-profile-img rounded-circle img-fluid mb-3" src=https://travisbikkle.github.io/images/logo_hub7ff5b15a111a79c0ee3a783e6fa4fdd_94335_100x0_resize_box_3.2c8235dff2d8e5b1eef17e65f5018ccf.png alt loading=lazy height=100 width=100></picture><p class="hb-blog-sidebar-profile-title text-center h5 mb-2">奇风岁月</p><p class="hb-blog-sidebar-profile-desc text-center mb-2">Travis Bikkle 的博客</p><p class="hb-blog-sidebar-profile-meta mb-0"></p></div><div class="hb-blog-sidebar-posts hb-module"><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=recent-posts-tab data-bs-toggle=tab data-bs-target=#recent-posts type=button role=tab aria-controls=recent-posts aria-selected=true>
最近文章</button></li></ul><div class="tab-content mt-2"><div class="tab-pane slide active" id=recent-posts role=tabpanel aria-labelledby=recent-posts-tab tabindex=0><div class=slide><div class="slide-inner row row-cols-1"><div class="slide-item px-0"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 bg-transparent mb-0"><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href=/2024/06/tplink-war2600l-iptables/><picture><source srcset=/images/thumbnail_huf912802dfb8692df6aa538a77227779b_19492_5fee225e1b582beabe5b51b7760f7d5c.webp type=image/webp><img class=hb-blog-post-card-img src=https://travisbikkle.github.io/images/thumbnail_huf912802dfb8692df6aa538a77227779b_19492_0x360_resize_q75_box.cef7eefc3c2ff604cf25cd7d5567b6ee.jpg alt="TP-LINK WAR-2600L 路由器 DMZ 功能分析" loading=lazy height=360 width=541></picture></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="TP-LINK WAR-2600L 路由器 DMZ 功能分析" href=/2024/06/tplink-war2600l-iptables/>TP-LINK WAR-2600L 路由器 DMZ 功能分析</a></div></div></div></div><div class="slide-item px-0"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 bg-transparent mb-0"><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href=/2024/05/2024-05-17-electron-log-v5/><picture><source srcset=/images/thumbnail_huf912802dfb8692df6aa538a77227779b_19492_5fee225e1b582beabe5b51b7760f7d5c.webp type=image/webp><img class=hb-blog-post-card-img src=https://travisbikkle.github.io/images/thumbnail_huf912802dfb8692df6aa538a77227779b_19492_0x360_resize_q75_box.cef7eefc3c2ff604cf25cd7d5567b6ee.jpg alt="electron-log@5 的使用" loading=lazy height=360 width=541></picture></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="electron-log@5 的使用" href=/2024/05/2024-05-17-electron-log-v5/>electron-log@5 的使用</a></div></div></div></div><div class="slide-item px-0"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 bg-transparent mb-0"><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href=/2024/04/2024-04-23-webpack-electron-node-addon/><picture><source srcset=/images/thumbnail_huf912802dfb8692df6aa538a77227779b_19492_5fee225e1b582beabe5b51b7760f7d5c.webp type=image/webp><img class=hb-blog-post-card-img src=https://travisbikkle.github.io/images/thumbnail_huf912802dfb8692df6aa538a77227779b_19492_0x360_resize_q75_box.cef7eefc3c2ff604cf25cd7d5567b6ee.jpg alt="在 webapck+electron+typescript中使用go开发的node插件" loading=lazy height=360 width=541></picture></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="在 webapck+electron+typescript中使用go开发的node插件" href=/2024/04/2024-04-23-webpack-electron-node-addon/>在 webapck+electron+typescript中使用go开发的node插件</a></div></div></div></div><div class="slide-item px-0"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 bg-transparent mb-0"><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href=/2024/03/2024-03-15-webpack-react-mock/><picture><source srcset=/images/thumbnail_huf912802dfb8692df6aa538a77227779b_19492_5fee225e1b582beabe5b51b7760f7d5c.webp type=image/webp><img class=hb-blog-post-card-img src=https://travisbikkle.github.io/images/thumbnail_huf912802dfb8692df6aa538a77227779b_19492_0x360_resize_q75_box.cef7eefc3c2ff604cf25cd7d5567b6ee.jpg alt="webpack 5 mock 10分钟快速配置" loading=lazy height=360 width=541></picture></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="webpack 5 mock 10分钟快速配置" href=/2024/03/2024-03-15-webpack-react-mock/>webpack 5 mock 10分钟快速配置</a></div></div></div></div><div class="slide-item px-0"><div class="hb-blog-post-card card border-0 overflow-hidden h-100 bg-transparent mb-0"><a class="card-img-top overflow-hidden border border-secondary-subtle text-body text-decoration-none mt-2" href=/2024/03/vmware-freeze/><picture><source srcset=/images/thumbnail_huf912802dfb8692df6aa538a77227779b_19492_5fee225e1b582beabe5b51b7760f7d5c.webp type=image/webp><img class=hb-blog-post-card-img src=https://travisbikkle.github.io/images/thumbnail_huf912802dfb8692df6aa538a77227779b_19492_0x360_resize_q75_box.cef7eefc3c2ff604cf25cd7d5567b6ee.jpg alt="Vmware 死机但是鼠标可以动" loading=lazy height=360 width=541></picture></a><div class="card-body px-0 py-2 d-flex flex-column"><div class="hb-blog-post-title card-title h5 py-1"><a class="hb-blog-post-title-link d-block" title="Vmware 死机但是鼠标可以动" href=/2024/03/vmware-freeze/>Vmware 死机但是鼠标可以动</a></div></div></div></div></div><button class=slide-control-left>
<svg aria-hidden="true" class="bi bi-arrow-left-circlebi bi-arrow-left-circle hi-svg-inline slide-control-left-icon" fill="currentcolor" height="2em" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1 8a7 7 0 1014 0A7 7 0 001 8m15 0A8 8 0 110 8a8 8 0 0116 0m-4.5-.5a.5.5.0 010 1H5.707l2.147 2.146a.5.5.0 01-.708.708l-3-3a.5.5.0 010-.708l3-3a.5.5.0 11.708.708L5.707 7.5z"/></svg><span class=visually-hidden>向左</span>
</button>
<button class=slide-control-right>
<svg aria-hidden="true" class="bi bi-arrow-right-circlebi bi-arrow-right-circle hi-svg-inline slide-control-right-icon" fill="currentcolor" height="2em" viewBox="0 0 16 16" width="2em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1 8a7 7 0 1014 0A7 7 0 001 8m15 0A8 8 0 110 8a8 8 0 0116 0M4.5 7.5a.5.5.0 000 1h5.793l-2.147 2.146a.5.5.0 00.708.708l3-3a.5.5.0 000-.708l-3-3a.5.5.0 10-.708.708L10.293 7.5z"/></svg><span class=visually-hidden>向右</span></button></div></div></div></div><div class="hb-blog-sidebar-taxonomies hb-module"><ul class="nav nav-pills nav-justified mb-2" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=taxonomy-categories-tab data-bs-toggle=tab data-bs-target=#taxonomy-categories-tab-pane type=button role=tab aria-controls=taxonomy-categories-tab-pane aria-selected=true>分类</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomy-series-tab data-bs-toggle=tab data-bs-target=#taxonomy-series-tab-pane type=button role=tab aria-controls=taxonomy-series-tab-pane aria-selected=false>专栏</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomy-tags-tab data-bs-toggle=tab data-bs-target=#taxonomy-tags-tab-pane type=button role=tab aria-controls=taxonomy-tags-tab-pane aria-selected=false>标签</button></li></ul><div class=tab-content><div class="tab-pane fade show active" id=taxonomy-categories-tab-pane role=tabpanel aria-labelledby=taxonomy-categories-tab tabindex=0><a class="taxonomy-term taxonomy-term-categories btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/categories/archived/><span class=taxonomy-term-title>Archived</span>
<small class="taxonomy-term-count border rounded px-1">35</small>
</a><a class="taxonomy-term taxonomy-term-categories btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/categories/tips/><span class=taxonomy-term-title>Tips</span>
<small class="taxonomy-term-count border rounded px-1">28</small>
</a><a class="taxonomy-term taxonomy-term-categories btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/categories/front-end/><span class=taxonomy-term-title>Front-End</span>
<small class="taxonomy-term-count border rounded px-1">3</small>
</a><a class="taxonomy-term taxonomy-term-categories btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/categories/browser-plugins/><span class=taxonomy-term-title>Browser Plugins</span>
<small class="taxonomy-term-count border rounded px-1">1</small>
</a><a class="taxonomy-term taxonomy-term-categories btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/categories/unity-3d/><span class=taxonomy-term-title>Unity 3D</span>
<small class="taxonomy-term-count border rounded px-1">1</small></a></div><div class="tab-pane fade" id=taxonomy-series-tab-pane role=tabpanel aria-labelledby=taxonomy-series-tab tabindex=0><a class="taxonomy-term taxonomy-term-series btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/series/dev-environment-setup/><span class=taxonomy-term-title>Dev Environment Setup</span>
<small class="taxonomy-term-count border rounded px-1">7</small>
</a><a class="taxonomy-term taxonomy-term-series btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/series/great-blog-plugins/><span class=taxonomy-term-title>Great Blog Plugins</span>
<small class="taxonomy-term-count border rounded px-1">3</small>
</a><a class="taxonomy-term taxonomy-term-series btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/series/linux-network-analysis/><span class=taxonomy-term-title>Linux NetWork Analysis</span>
<small class="taxonomy-term-count border rounded px-1">2</small>
</a><a class="taxonomy-term taxonomy-term-series btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/series/linux-performance-analysis/><span class=taxonomy-term-title>Linux Performance Analysis</span>
<small class="taxonomy-term-count border rounded px-1">2</small>
</a><a class="taxonomy-term taxonomy-term-series btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/series/data-structures-algorithms/><span class=taxonomy-term-title>Data Structures & Algorithms</span>
<small class="taxonomy-term-count border rounded px-1">1</small>
</a><a class="taxonomy-term taxonomy-term-series btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/series/windows-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/><span class=taxonomy-term-title>Windows 常用配置</span>
<small class="taxonomy-term-count border rounded px-1">1</small></a></div><div class="tab-pane fade" id=taxonomy-tags-tab-pane role=tabpanel aria-labelledby=taxonomy-tags-tab tabindex=0><a class="taxonomy-term taxonomy-term-tags btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/linux/><span class=taxonomy-term-title>Linux</span>
<small class="taxonomy-term-count border rounded px-1">19</small>
</a><a class="taxonomy-term taxonomy-term-tags btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/vmware/><span class=taxonomy-term-title>vmware</span>
<small class="taxonomy-term-count border rounded px-1">4</small>
</a><a class="taxonomy-term taxonomy-term-tags btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/windows/><span class=taxonomy-term-title>Windows</span>
<small class="taxonomy-term-count border rounded px-1">3</small>
</a><a class="taxonomy-term taxonomy-term-tags btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/electron/><span class=taxonomy-term-title>electron</span>
<small class="taxonomy-term-count border rounded px-1">2</small>
</a><a class="taxonomy-term taxonomy-term-tags btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/network/><span class=taxonomy-term-title>NetWork</span>
<small class="taxonomy-term-count border rounded px-1">2</small>
</a><a class="taxonomy-term taxonomy-term-tags btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/performance/><span class=taxonomy-term-title>Performance</span>
<small class="taxonomy-term-count border rounded px-1">2</small>
</a><a class="taxonomy-term taxonomy-term-tags btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/webpack/><span class=taxonomy-term-title>webpack</span>
<small class="taxonomy-term-count border rounded px-1">2</small>
</a><a class="taxonomy-term taxonomy-term-tags btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/adobe/><span class=taxonomy-term-title>Adobe</span>
<small class="taxonomy-term-count border rounded px-1">1</small>
</a><a class="taxonomy-term taxonomy-term-tags btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/k8s/><span class=taxonomy-term-title>k8s</span>
<small class="taxonomy-term-count border rounded px-1">1</small>
</a><a class="taxonomy-term taxonomy-term-tags btn btn-sm btn-outline-secondary p-1 me-1 mb-1" href=/mock/><span class=taxonomy-term-title>mock</span>
<small class="taxonomy-term-count border rounded px-1">1</small></a></div></div></div></div></div></div><footer class="hb-footer pt-4 pt-md-5 pb-2 pb-md-3 bg-body-tertiary"><div class="container-fluid container-lg px-4 px-md-3"><div class=row><div class="hb-footer-site-info col mb-2 text-center"><div class=h5>奇风岁月</div><ul class="list-unstyled small mb-2"><li class=mt-2>Travis Bikkle 的博客</li><li class=mt-2>Copyright © 2022-2024 Travis Bikkle. All Rights Reserved.</li><li class=mt-2>Built with ❤️ from <a class=text-body-emphasis href=https://gohugo.io/ target=_blank rel=external title=Hugo>Hugo</a>, <a class=text-body-emphasis href=https://hugomods.com/ target=_blank rel=external title=HugoMods>HugoMods</a> and <a class=text-body-emphasis href=https://hbstack.dev/ target=_blank rel=external title="HB Framework">HB Framework</a>.</li></ul><div class="hb-footer-socials d-flex mb-2 justify-content-center flex-wrap"><a class="hb-social p-2" href=https://github.com/travisbikkle target=_blank rel="nofollow me" title=GitHub><svg aria-hidden="true" class="hi-svg-inline hb-social-icon" fill="currentcolor" height="1.75em" role="img" style="color:%!s(bool=true)" viewBox="0 0 24 24" width="1.75em" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="hb-social p-2" href=/index.xml target=_blank rel="nofollow me" title=RSS><svg aria-hidden="true" class="bi bi-rss-fillbi bi-rss-fill hi-svg-inline hb-social-icon" fill="currentcolor" height="1.75em" style="color:%!s(bool=true)" viewBox="0 0 16 16" width="1.75em" xmlns="http://www.w3.org/2000/svg"><path d="M2 0A2 2 0 000 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2zm1.5 2.5c5.523.0 10 4.477 10 10a1 1 0 11-2 0 8 8 0 00-8-8 1 1 0 010-2m0 4a6 6 0 016 6 1 1 0 11-2 0 4 4 0 00-4-4 1 1 0 010-2m.5 7a1.5 1.5.0 110-3 1.5 1.5.0 010 3"/></svg></a></div></div></div></div></footer><script src=/js/hb.c7b65cef1dfa55b620482ff476522779b3dadca23435a99104f8a6c78df8475e.js integrity="sha256-x7Zc7x36VbYgSC/0dlInebPa3KI0NamRBPimx434R14=" defer></script><script src=/js/aos.min.js></script><script src=/js/aos-init.ddabf147c2db800b5e5adb3100d34df450314b817a6dd0949796957b7bb24443.js></script><script src=https://giscus.app/client.js data-repo=travisbikkle/travisbikkle.github.io data-repo-id=R_kgDOLJcE0Q data-category=General data-category-id=DIC_kwDOLJcE0c4CcrlY data-mapping=og:title data-reactions-enabled=1 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy data-strict=1 crossorigin=anonymous onload='document.body.dispatchEvent(new Event("giscus-load"))' async></script><script src=/js/search.8d102b1ba049da94665bb514f3ab6b87bb0f88aeb42d746050c770c9ad62a1d0.js defer></script><script>"serviceWorker"in navigator&&window.addEventListener("DOMContentLoaded",function(){navigator.serviceWorker.register("/sw.js")})</script></body></html>